<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Coleta Transfer Inauguração</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
<style>
  /* ====== APP / MOBILE FIRST STYLES ====== */
  :root{
    --bg1:#05060a; --bg2:#0f1224; --accent:#00ffd5; --accent-2:#00b89c;
    --panel: rgba(255,255,255,0.03);
  }
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:
    linear-gradient(180deg,var(--bg1),var(--bg2)); color:#e6fff9; -webkit-font-smoothing:antialiased;}
  /* header */
  .hdr{
    height:56px; display:flex; align-items:center; gap:12px; padding:8px 14px;
    background: linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-bottom:1px solid rgba(255,255,255,0.02);
    position:fixed; left:0; right:0; top:0; z-index:9999;
  }
  .hdr .logo{ width:36px; height:36px; border-radius:8px; background:#fff; display:inline-block; }
  .hdr .title{ font-weight:700; font-size:16px; color:var(--accent); letter-spacing:0.8px; }
  /* app container */
  .app{ padding:68px 10px 12px 10px; box-sizing:border-box; height:calc(100vh - 56px); display:flex; flex-direction:column; gap:8px; }
  /* controls */
  .controls{ display:flex; gap:8px; align-items:center; }
  .select{ flex:1; height:46px; border-radius:10px; border:none; padding:0 12px; background:rgba(255,255,255,0.02); color:#fff; font-size:15px; }
  .btn{ background:var(--accent); color:#000; border:none; padding:10px 12px; border-radius:10px; font-weight:700; min-width:86px; }
  .btn.alt{ background:#ff6b6b; color:#fff; }
  /* list */
  .list{ background:var(--panel); border-radius:12px; padding:8px; max-height:28vh; overflow:auto; box-shadow:0 12px 40px rgba(0,0,0,0.6); }
  .item{ display:flex; justify-content:space-between; align-items:center; gap:8px; padding:10px; border-radius:10px; margin-bottom:8px; background: linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005)); }
  .meta{ display:flex; flex-direction:column; gap:4px; }
  .hora{ color:var(--accent); font-weight:800; font-size:15px; }
  .ponto{ color:#d7fff0; opacity:0.95; font-size:13px; }
  .name{ color:#cfeee0; font-size:12px; }
  .confirm{ background:#ff3b30; color:#fff; border:none; padding:8px 12px; border-radius:8px; font-weight:800; }
  /* map */
  #map{ flex:1; width:100%; border-radius:12px; box-shadow:0 18px 60px rgba(0,0,0,0.6); overflow:hidden; }
  /* blinking */
  @keyframes blinkGlow { 0%,100%{filter:drop-shadow(0 0 0px var(--accent)); transform:scale(1);} 50%{filter:drop-shadow(0 0 18px var(--accent)); transform:scale(1.02);} }
  .leaflet-marker-icon.blink-alert{ animation:blinkGlow 1s linear infinite; z-index:1000!important; }
  .leaflet-marker-icon.dimmed{ opacity:0.28; }
  /* desktop overlay to force mobile usage */
  #desktopOverlay{ display:none; position:fixed; inset:0; z-index:999999; background:linear-gradient(180deg, rgba(0,0,0,0.65), rgba(0,0,0,0.85)); align-items:center; justify-content:center; padding:20px; text-align:center; }
  #desktopOverlay .card{ background:rgba(255,255,255,0.03); padding:18px; border-radius:12px; max-width:460px; color:#fff; box-shadow:0 20px 60px rgba(0,0,0,0.6); }
  @media(min-width:900px){ #desktopOverlay{ display:flex; } .app{ filter:blur(2px); } }
  /* floating confirm button */
  .float-confirm{ position:fixed; bottom:18px; left:50%; transform:translateX(-50%); z-index:99999; background:var(--accent); color:#000; padding:12px 18px; font-weight:800; border-radius:12px; display:none; box-shadow:0 10px 30px rgba(0,0,0,0.5); }
</style>
</head>
<body>

<!-- header -->
<div class="hdr">
  <div class="logo" aria-hidden="true"></div>
  <div class="title">Coleta Transfer Inauguração</div>
</div>

<!-- desktop overlay -->
<div id="desktopOverlay" aria-hidden="true">
  <div class="card">
    <h2 style="margin:0 0 8px;color:var(--accent)">Abra no celular</h2>
    <p style="margin:0;color:#ddd">Este painel foi otimizado como um webapp de navegação para celular. Abra o link no navegador do seu celular para usar GPS, voz e navegação.</p>
    <p style="margin-top:10px;color:#bbb;font-size:13px">Para testar no desktop, reduza a largura da janela ou comente a checagem.</p>
  </div>
</div>

<!-- app body -->
<div class="app" id="app">
  <div class="controls" role="region" aria-label="Controles">
    <select id="hour-filter" class="select" aria-label="Filtrar por horário">
      <option value="">Mostrar todos (apenas reservas ≥ 19:00)</option>
    </select>
    <button id="btnFilter" class="btn">Filtrar</button>
    <button id="btnClear" class="btn alt">Limpar</button>
  </div>

  <div class="list" id="list">
    <!-- cards de passageiros -->
  </div>

  <div id="map"></div>
</div>

<button id="floatConfirm" class="float-confirm">✅ Confirmar Embarque</button>

<!-- libs -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<script>
/* ================= CONFIG ================== */
const SHEET_ID = "132fh2lxEE2vzpfBmAbYCsk4UtRJAZ6fjdLEplUqbwFc";
const API_KEY  = "AIzaSyCkkBqKGxqPsBHK4-tQN_8DhdNMmX4gaqU";
const RANGE     = "A:E";
const URL       = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`;

let allData = [];          // rows loaded meeting date+>=19:00 and not already embarcado
let filteredData = [];     // filtered by hour selection
let embarcados = JSON.parse(localStorage.getItem('embarcados_v2') || '[]'); // persisted confirmed
const markersByName = {};
let map = null, routingControl = null, driverMarker = null, watchId = null;
let prevPosition = null; // for heading estimation

/* pontos (mesmo set) */
const pontos = [
  {nome:"PORTARIA", coords:[-19.9978072,-43.9266727]},
  {nome:"Ponto 30", coords:[-19.9977078,-43.9289372]},
  {nome:"Ponto 28", coords:[-19.9986592,-43.9306448]},
  {nome:"Ponto 29", coords:[-19.999421,-43.9326796]},
  {nome:"Ponto 27", coords:[-20.0002531,-43.9314901]},
  {nome:"Ponto 26", coords:[-20.0015469,-43.9333477]},
  {nome:"Ponto 24", coords:[-20.003258,-43.9296246]},
  {nome:"Ponto 25", coords:[-20.0050238,-43.9308419]},
  {nome:"Ponto 21", coords:[-20.0027213,-43.9338594]},
  {nome:"Ponto 22", coords:[-20.001474,-43.9355339]},
  {nome:"Ponto 23", coords:[-20.0031588,-43.9364208]},
  {nome:"Ponto 20", coords:[-20.0063663,-43.934352]},
  {nome:"Ponto 19", coords:[-20.0085746,-43.9318072]},
  {nome:"Ponto 17", coords:[-20.0104645,-43.9320381]},
  {nome:"Ponto 18", coords:[-20.0088433,-43.9343321]},
  {nome:"Ponto 12", coords:[-20.0088434,-43.9288248]},
  {nome:"Ponto 13", coords:[-20.0094456,-43.9269802]},
  {nome:"Ponto 14", coords:[-20.0075172,-43.9277972]},
  {nome:"Ponto 16", coords:[-20.0068404,-43.9290337]},
  {nome:"Ponto 15", coords:[-20.0079616,-43.9293497]},
  {nome:"Ponto 09", coords:[-20.0110997,-43.9309597]},
  {nome:"Ponto 10", coords:[-20.0120307,-43.9334509]},
  {nome:"Ponto 11", coords:[-20.0098192,-43.9337648]},
  {nome:"Ponto 08", coords:[-20.0102615,-43.9273848]},
  {nome:"Ponto 05", coords:[-20.0114455,-43.9257426]},
  {nome:"Ponto 06", coords:[-20.0112228,-43.9276231]},
  {nome:"Ponto 07", coords:[-20.0108785,-43.9296971]},
  {nome:"Ponto 04", coords:[-20.0068997,-43.9238609]},
  {nome:"Ponto 03", coords:[-20.0047577,-43.9260624]},
  {nome:"Ponto 02", coords:[-20.001753,-43.9270223]}
];

/* ================ UTILITÁRIOS ================ */
function isMobile() {
  return /Mobi|Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
}
function todayStringYYYYMMDD(){
  const n = new Date();
  return `${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}-${String(n.getDate()).padStart(2,'0')}`;
}
function parseSheetDateTime(dt){
  if(!dt) return null;
  // Expecting "DD/MM/YYYY HH:MM" or similar (user's format)
  if(dt.includes('/')){
    const parts = dt.split(' ');
    const d = parts[0].split('/');
    const t = (parts[1]||'00:00').split(':');
    const day = parseInt(d[0],10), month = parseInt(d[1],10)-1, year = parseInt(d[2],10);
    const hour = parseInt(t[0]||0,10), min = parseInt(t[1]||0,10);
    return new Date(year, month, day, hour, min);
  }
  // fallback
  const maybe = new Date(dt);
  return isNaN(maybe) ? null : maybe;
}
function bookingKey(row){
  // unique key: solicitante + ponto + original date string
  return `${(row[1]||'').trim()}___${(row[2]||'').trim()}___${(row[0]||'').trim()}`;
}
function speak(text){
  if(!('speechSynthesis' in window)) return;
  try{
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'pt-BR';
    u.rate = 1.0;
    window.speechSynthesis.cancel(); // avoid overlaps
    window.speechSynthesis.speak(u);
  }catch(e){ console.warn('speech err', e); }
}
/* bearing between two latlngs */
function bearing(lat1, lon1, lat2, lon2){
  const toRad = Math.PI/180, toDeg = 180/Math.PI;
  const y = Math.sin((lon2-lon1)*toRad)*Math.cos(lat2*toRad);
  const x = Math.cos(lat1*toRad)*Math.sin(lat2*toRad) - Math.sin(lat1*toRad)*Math.cos(lat2*toRad)*Math.cos((lon2-lon1)*toRad);
  const brng = (Math.atan2(y,x)*toDeg+360)%360;
  return brng;
}
/* distance in meters */
function haversine([lat1,lon1],[lat2,lon2]){
  const R=6371000;
  const toRad=Math.PI/180;
  const dLat=(lat2-lat1)*toRad, dLon=(lon2-lon1)*toRad;
  const a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*toRad)*Math.cos(lat2*toRad)*Math.sin(dLon/2)*Math.sin(dLon/2);
  const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  return R*c;
}

/* ================ MAP & MARKERS ================ */
function initMap(){
  if(map) return;
  map = L.map('map',{ zoomControl:false }).setView([-19.9978072,-43.9266727],15);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'&copy; OpenStreetMap' }).addTo(map);
  const icon = L.icon({ iconUrl:'Ponto.png', iconSize:[36,36], iconAnchor:[18,36] });
  pontos.forEach(p=>{
    const m = L.marker(p.coords, {icon}).addTo(map).bindPopup(p.nome);
    markersByName[p.nome] = m;
  });
}

/* set blink on specific pontos */
function clearBlinkAll(){
  Object.values(markersByName).forEach(m=>{
    const el = m._icon || (m.getElement && m.getElement());
    if(el){ el.classList.remove('blink-alert'); el.classList.remove('dimmed'); }
    m.setZIndexOffset(0);
  });
}
function setBlinkFor(names){
  // dim all then highlight selected
  Object.values(markersByName).forEach(m=>{
    const el = m._icon || (m.getElement && m.getElement());
    if(el){ el.classList.add('dimmed'); el.onclick = null; }
  });
  names.forEach(n=>{
    const m = markersByName[n];
    if(!m) return;
    const el = m._icon || (m.getElement && m.getElement());
    if(!el) return;
    el.classList.remove('dimmed'); el.classList.add('blink-alert');
    m.setZIndexOffset(1000);
    // clicking on marker confirms the first matching booking for that ponto
    el.onclick = ()=>{
      const row = (filteredData.length ? filteredData : allData).find(r => r[2] === n);
      if(row) confirmEmbarque(row);
    };
  });
}

/* ================ UI render ================ */
const listEl = document.getElementById('list');
const hourSelect = document.getElementById('hour-filter');
function renderList(data){
  listEl.innerHTML = '';
  if(!data.length){
    listEl.innerHTML = '<div style="padding:12px;color:#cfe">Nenhum agendamento (apenas reservas a partir das 19:00 são carregadas).</div>';
    clearBlinkAll();
    return;
  }
  data.forEach(row=>{
    const dt = parseSheetDateTime(row[0]) || null;
    const hora = dt ? `${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}` : (row[0]||'');
    const solicit = row[1] || '';
    const ponto = row[2] || '';
    const key = bookingKey(row);
    const item = document.createElement('div'); item.className = 'item';
    item.innerHTML = `
      <div class="meta">
        <div class="hora">${hora}</div>
        <div class="ponto">${ponto}</div>
        <div class="name">${solicit}</div>
      </div>
      <div><button class="confirm" data-key="${encodeURIComponent(key)}">EMBARCAR</button></div>
    `;
    const btn = item.querySelector('button');
    btn.addEventListener('click', ()=>{
      confirmEmbarque(row);
    });
    listEl.appendChild(item);
  });
  setBlinkFor(data.map(r=>r[2]));
}

/* populate hour list for filter (unique hh:mm) */
function populateHourSelect(data){
  const s = new Set();
  data.forEach(r=>{
    const dt = parseSheetDateTime(r[0]);
    if(dt) s.add(`${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}`);
  });
  const arr = Array.from(s).sort();
  hourSelect.innerHTML = '<option value="">Mostrar todos (≥ 19:00)</option>';
  arr.forEach(h=>{
    const o = document.createElement('option'); o.value = h; o.textContent = h; hourSelect.appendChild(o);
  });
}

/* ================ FETCH bookings (today & >=19:00 & not embarcado) ================ */
async function fetchBookings(){
  try{
    const res = await fetch(URL);
    const json = await res.json();
    if(!json || !json.values || json.values.length <= 1){
      allData = []; filteredData = []; renderList([]);
      return;
    }
    const rows = json.values.slice(1);
    const today = todayStringYYYYMMDD();
    const filtered = rows.filter(r=>{
      const dt = parseSheetDateTime(r[0]);
      if(!dt) return false;
      const yyyy = dt.getFullYear(), mm = String(dt.getMonth()+1).padStart(2,'0'), dd = String(dt.getDate()).padStart(2,'0');
      const ddStr = `${yyyy}-${mm}-${dd}`;
      if(ddStr !== today) return false;
      if(dt.getHours() < 19) return false; // only >=19:00
      // exclude those already embarcados (persisted)
      const key = bookingKey(r);
      if(embarcados.includes(key)) return false;
      return true;
    });
    allData = filtered;
    filteredData = allData.slice();
    initMap();
    renderList(filteredData);
    populateHourSelect(allData);
  }catch(e){
    console.error(e);
    alert('Erro ao carregar agendamentos.');
  }
}

/* ================ FILTERS, ROUTE and GEO ================ */
function applyFilter(){
  const v = hourSelect.value;
  if(!v) filteredData = allData.slice();
  else filteredData = allData.filter(r=>{
    const dt = parseSheetDateTime(r[0]);
    if(!dt) return false;
    const hhmm = `${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}`;
    return hhmm === v;
  });
  renderList(filteredData);
  if(filteredData.length){
    document.getElementById('map').style.display = 'block';
    startTrackingAndRoute();
  } else {
    clearBlinkAll();
    if(routingControl){ map.removeControl(routingControl); routingControl = null; }
  }
}

/* Start watchPosition and setup routing to agendados */
function startTrackingAndRoute(){
  const nomes = filteredData.map(r=>r[2]);
  const agendados = pontos.filter(p=>nomes.includes(p.nome));
  if(!agendados.length) return;
  // ensure map and markers
  initMap();
  // fit bounds
  const group = L.featureGroup(agendados.map(p=>markersByName[p.nome]));
  map.fitBounds(group.getBounds().pad(0.2));
  // start geolocation
  if(navigator.geolocation){
    if(watchId === null){
      watchId = navigator.geolocation.watchPosition(pos=>{
        const lat = pos.coords.latitude, lon = pos.coords.longitude;
        // update driver marker
        if(!driverMarker){
          const busIcon = L.icon({ iconUrl:'Onibus.png', iconSize:[40,40], iconAnchor:[20,20] });
          driverMarker = L.marker([lat,lon],{icon:busIcon}).addTo(map).bindPopup('Você está aqui');
        } else {
          driverMarker.setLatLng([lat,lon]);
        }
        // compute heading
        let heading = null;
        if(typeof pos.coords.heading === 'number' && !isNaN(pos.coords.heading)) heading = pos.coords.heading;
        else if(prevPosition){
          const prev = prevPosition;
          heading = bearing(prev.lat, prev.lon, lat, lon);
        }
        prevPosition = { lat, lon, t:Date.now() };
        // compute next waypoint (first in agendados list)
        if(agendados.length){
          const next = agendados[0];
          const dist = haversine([lat,lon], next.coords);
          // announce if close
          if(dist < 80){ // within 80m
            speak(`Próximo destino: ${next.nome}. Prepare-se para embarcar.`);
          } else {
            // announce basic direction once when route set or if big heading change
            const brngToNext = bearing(lat, lon, next.coords[0], next.coords[1]);
            if(heading !== null){
              const diff = ((brngToNext - heading + 540)%360)-180; // -180..180
              if(Math.abs(diff) > 30){
                const turn = diff > 0 ? 'vire à direita' : 'vire à esquerda';
                speak(turn);
              } else {
                speak('siga em frente');
              }
            } else {
              // no heading info
              speak(`Siga em direção ao ${next.nome}`);
            }
          }
        }
        // update route control
        updateRoutingControl([lat,lon], agendados);
      }, err=>{
        console.warn('Geo error', err);
      }, { enableHighAccuracy:true, maximumAge:2000, timeout:10000 });
    }
  } else {
    // just fit bounds
    if(agendados.length){
      const group = L.featureGroup(agendados.map(p=>markersByName[p.nome]));
      map.fitBounds(group.getBounds().pad(0.3));
    }
  }
}

/* update routing control */
function updateRoutingControl(userLatLng, agendados){
  if(routingControl){ map.removeControl(routingControl); routingControl = null; }
  const waypoints = [L.latLng(userLatLng[0], userLatLng[1])].concat(agendados.map(a=>L.latLng(a.coords[0], a.coords[1])));
  routingControl = L.Routing.control({
    waypoints,
    routeWhileDragging:false,
    draggableWaypoints:false,
    addWaypoints:false,
    createMarker: ()=> null,
    show:false,
    collapsible:true
  }).addTo(map);
  // hide the UI of the router if present
  const rc = document.querySelector('.leaflet-routing-container');
  if(rc) rc.style.display = 'none';
  // announce route created
  if(agendados.length){
    speak(`Rota atualizada. Próximo destino: ${agendados[0].nome}`);
  }
}

/* ================ CONFIRMAR EMBARQUE ================ */
/* Accepts the booking row object */
function confirmEmbarque(row){
  const key = bookingKey(row);
  if(!embarcados.includes(key)) embarcados.push(key);
  localStorage.setItem('embarcados_v2', JSON.stringify(embarcados));
  // remove booking from arrays
  allData = allData.filter(r => bookingKey(r) !== key);
  filteredData = filteredData.filter(r => bookingKey(r) !== key);
  // stop blink for that point and optionally remove marker
  const ponto = row[2];
  const marker = markersByName[ponto];
  if(marker){
    const el = marker._icon || (marker.getElement && marker.getElement());
    if(el){ el.classList.remove('blink-alert'); el.classList.remove('dimmed'); }
    // optionally remove marker: map.removeLayer(marker);
    // delete markersByName[ponto];
  }
  // re-render
  renderList(filteredData.length ? filteredData : allData);
  // recompute route
  const nomes = (filteredData.length ? filteredData : allData).map(r => r[2]);
  const agendados = pontos.filter(p => nomes.includes(p.nome));
  if(agendados.length && driverMarker){
    const pos = driverMarker.getLatLng();
    updateRoutingControl([pos.lat,pos.lng], agendados);
  } else if(routingControl){
    map.removeControl(routingControl); routingControl=null;
  }
  speak('Embarque confirmado.');
}

/* wrapper for list buttons (encoded key) */
function confirmEmbarqueByKey(encoded){
  const key = decodeURIComponent(encoded);
  const row = (filteredData.concat(allData)).find(r => bookingKey(r) === key);
  if(row) confirmEmbarque(row);
}

/* ================ BIND UI ================ */
document.getElementById('btnFilter').addEventListener('click', applyFilter);
document.getElementById('btnClear').addEventListener('click', ()=>{
  hourSelect.value=''; filteredData = allData.slice(); renderList(filteredData); clearBlinkAll();
  if(routingControl){ map.removeControl(routingControl); routingControl = null; }
});

/* ================ INIT ================ */
(function init(){
  // mobile guard
  if(!isMobile()){
    document.getElementById('desktopOverlay').style.display = 'flex';
    return;
  } else {
    document.getElementById('desktopOverlay').style.display = 'none';
    // ensure map container visible
    document.getElementById('map').style.display = 'block';
  }
  // fetch bookings and init map
  fetchBookings();
})();

/*  Load bookings */
async function fetchBookings(){
  try{
    const res = await fetch(URL);
    const json = await res.json();
    if(!json || !json.values || json.values.length<=1){ allData = []; filteredData=[]; renderList([]); return; }
    const rows = json.values.slice(1);
    const today = todayStringYYYYMMDD();
    const kept = rows.filter(r=>{
      const dt = parseSheetDateTime(r[0]);
      if(!dt) return false;
      const yyyy = dt.getFullYear(), mm = String(dt.getMonth()+1).padStart(2,'0'), dd = String(dt.getDate()).padStart(2,'0');
      const rowDate = `${yyyy}-${mm}-${dd}`;
      if(rowDate !== today) return false;
      if(dt.getHours() < 19) return false; // only >= 19:00
      const key = bookingKey(r);
      if(embarcados.includes(key)) return false;
      return true;
    });
    allData = kept;
    filteredData = allData.slice();
    initMap();
    renderList(filteredData);
    populateHourSelect(allData);
    // speak about loaded count
    if(allData.length) speak(`${allData.length} agendamentos carregados. Filtre por horário para ver rota.`);
    else speak('Nenhum agendamento a partir das 19 horas encontrado hoje.');
  }catch(e){
    console.error(e); alert('Erro ao buscar planilha.');
  }
}
</script>
</body>
</html>
