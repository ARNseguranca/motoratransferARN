<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Coleta Transfer Inauguração - Driver</title>

<!-- estilos mobile-first -->
<style>
  :root{
    --bg1:#05060a; --bg2:#0f1224; --accent:#00ffd5; --muted:rgba(255,255,255,0.08);
  }
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,var(--bg1),var(--bg2)); color:#eafffb;}
  /* header */
  header{height:56px; position:fixed; left:0; right:0; top:0; z-index:9999; display:flex; align-items:center; gap:12px; padding:8px 12px; background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-bottom:1px solid rgba(255,255,255,0.02);}
  .logo{width:36px;height:36px;border-radius:8px;background:#fff;}
  .title{color:var(--accent); font-weight:700; font-size:17px;}
  /* main app */
  .app{padding:70px 10px 12px; height:calc(100vh - 56px); box-sizing:border-box; display:flex; flex-direction:column; gap:8px;}
  .controls{display:flex; gap:8px; align-items:center;}
  .select{flex:1;height:46px;border-radius:10px;border:none;padding:0 12px;background:var(--muted); color:#fff;}
  .btn{background:var(--accent); color:#000; border:none; padding:10px 12px; border-radius:10px; font-weight:800;}
  .list{background:rgba(255,255,255,0.03); border-radius:12px; padding:8px; max-height:28vh; overflow:auto; box-shadow:0 14px 50px rgba(0,0,0,0.6);}
  .item{display:flex; justify-content:space-between; align-items:center; gap:8px; padding:10px; border-radius:10px; margin-bottom:8px; background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));}
  .meta{display:flex;flex-direction:column;}
  .hour{color:var(--accent); font-weight:900;}
  .point{color:#dff; font-size:13px;}
  .name{color:#cfe; font-size:12px;}
  #map{flex:1;border-radius:12px; overflow:hidden; box-shadow:0 18px 60px rgba(0,0,0,0.6);}
  /* blinking marker class (we'll add to elements created by Maps API) */
  @keyframes blinkGlow {0%,100%{filter:drop-shadow(0 0 0 var(--accent)); transform:scale(1);}50%{filter:drop-shadow(0 0 18px var(--accent)); transform:scale(1.02);}}
  .blink-alert{animation:blinkGlow 1s linear infinite;}
  .dimmed{opacity:0.25;}
  /* float confirm button */
  .float-confirm{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);z-index:99999;background:var(--accent);color:#000;padding:12px 18px;font-weight:900;border-radius:12px;display:none;box-shadow:0 10px 30px rgba(0,0,0,0.5);}
  /* desktop overlay: encourage mobile */
  #desktopOverlay{display:none; position:fixed;inset:0; background:rgba(0,0,0,0.8); z-index:999999; align-items:center; justify-content:center;}
  #desktopOverlay .card{background:rgba(255,255,255,0.02); padding:18px;border-radius:12px; color:#fff; max-width:420px; text-align:center;}
  @media(min-width:900px){ #desktopOverlay{display:flex;} .app{filter:blur(3px);} }
</style>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>

<header>
  <div class="logo" aria-hidden="true"></div>
  <div class="title">Coleta Transfer Inauguração</div>
</header>

<div id="desktopOverlay" aria-hidden="true">
  <div class="card">
    <h2 style="color:#00ffd5;margin:0 0 8px">Abra no celular</h2>
    <p style="color:#ddd;margin:0">Este painel foi otimizado como webapp de navegação para celular. Abra no navegador do seu celular para usar GPS e voz.</p>
  </div>
</div>

<div class="app" id="app">
  <div class="controls">
    <select id="hour-filter" class="select" aria-label="Filtrar horário">
      <option value="">Mostrar todos (apenas reservas ≥ 19:00)</option>
    </select>
    <button id="filterBtn" class="btn">Filtrar</button>
    <button id="clearBtn" class="btn" style="background:#ff6b6b;color:#fff">Limpar</button>
  </div>

  <div class="list" id="list"></div>
  <div id="map"></div>
</div>

<button id="floatConfirm" class="float-confirm">✅ Confirmar Embarque</button>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
/* ================== CONFIG ================== */
const SHEET_ID = "132fh2lxEE2vzpfBmAbYCsk4UtRJAZ6fjdLEplUqbwFc";
const SHEETS_API_KEY = "AIzaSyCkkBqKGxqPsBHK4-tQN_8DhdNMmX4gaqU";
const RANGE = "A:E";
const SHEETS_URL = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${SHEETS_API_KEY}`;

let allData = [];
let filteredData = [];
let embarcados = JSON.parse(localStorage.getItem('embarcados_v3') || '[]');
let map, driverMarker;
let markers = {};
let currentRouteSteps = [];
let nextStepIndex = 0;

/* pontos fixos */
const pontos = [
  {nome:"PORTARIA", coords:{lat:-19.9978072,lng:-43.9266727}},
  {nome:"Ponto 30", coords:{lat:-19.9977078,lng:-43.9289372}},
  {nome:"Ponto 28", coords:{lat:-19.9986592,lng:-43.9306448}},
  {nome:"Ponto 29", coords:{lat:-19.999421,lng:-43.9326796}},
  {nome:"Ponto 27", coords:{lat:-20.0002531,lng:-43.9314901}},
  {nome:"Ponto 26", coords:{lat:-20.0015469,lng:-43.9333477}},
  {nome:"Ponto 24", coords:{lat:-20.003258,lng:-43.9296246}},
  {nome:"Ponto 25", coords:{lat:-20.0050238,lng:-43.9308419}},
  {nome:"Ponto 21", coords:{lat:-20.0027213,lng:-43.9338594}},
  {nome:"Ponto 22", coords:{lat:-20.001474,lng:-43.9355339}},
  {nome:"Ponto 23", coords:{lat:-20.0031588,lng:-43.9364208}},
  {nome:"Ponto 20", coords:{lat:-20.0063663,lng:-43.934352}},
  {nome:"Ponto 19", coords:{lat:-20.0085746,lng:-43.9318072}},
  {nome:"Ponto 17", coords:{lat:-20.0104645,lng:-43.9320381}},
  {nome:"Ponto 18", coords:{lat:-20.0088433,lng:-43.9343321}},
  {nome:"Ponto 12", coords:{lat:-20.0088434,lng:-43.9288248}},
  {nome:"Ponto 13", coords:{lat:-20.0094456,lng:-43.9269802}},
  {nome:"Ponto 14", coords:{lat:-20.0075172,lng:-43.9277972}},
  {nome:"Ponto 16", coords:{lat:-20.0068404,lng:-43.9290337}},
  {nome:"Ponto 15", coords:{lat:-20.0079616,lng:-43.9293497}},
  {nome:"Ponto 09", coords:{lat:-20.0110997,lng:-43.9309597}},
  {nome:"Ponto 10", coords:{lat:-20.0120307,lng:-43.9334509}},
  {nome:"Ponto 11", coords:{lat:-20.0098192,lng:-43.9337648}},
  {nome:"Ponto 08", coords:{lat:-20.0102615,lng:-43.9273848}},
  {nome:"Ponto 05", coords:{lat:-20.0114455,lng:-43.9257426}},
  {nome:"Ponto 06", coords:{lat:-20.0112228,lng:-43.9276231}},
  {nome:"Ponto 07", coords:{lat:-20.0108785,lng:-43.9296971}},
  {nome:"Ponto 04", coords:{lat:-20.0068997,lng:-43.9238609}},
  {nome:"Ponto 03", coords:{lat:-20.0047577,lng:-43.9260624}},
  {nome:"Ponto 02", coords:{lat:-20.001753,lng:-43.9270223}}
];

/* ================= UTIL ================= */
function todayYMD(){
  const n = new Date();
  return `${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}-${String(n.getDate()).padStart(2,'0')}`;
}
function parseSheetDateTime(val){
  if(!val) return null;
  if(val.includes('/')){
    const [dpart, tpart='00:00'] = val.split(' ');
    const [d,m,y] = dpart.split('/');
    const [hh,mm] = tpart.split(':');
    const dt = new Date(Number(y), Number(m)-1, Number(d), Number(hh||0), Number(mm||0));
    return isNaN(dt) ? null : dt;
  }
  const dt = new Date(val);
  return isNaN(dt) ? null : dt;
}
function bookingKey(row){
  return `${(row[1]||'').trim()}___${(row[2]||'').trim()}___${(row[0]||'').trim()}`;
}
function speak(text){
  if(!('speechSynthesis' in window)) return;
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'pt-BR'; u.rate=1;
  try { window.speechSynthesis.cancel(); window.speechSynthesis.speak(u); } catch(e){}
}
function haversine([lat1,lon1],[lat2,lon2]){
  const R=6371000,r=Math.PI/180;
  const dLat=(lat2-lat1)*r, dLon=(lon2-lon1)*r;
  const a=Math.sin(dLat/2)**2+Math.cos(lat1*r)*Math.cos(lat2*r)*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(a));
}

/* ================== UI ================== */
const listEl = document.getElementById('list');
const hourSelect = document.getElementById('hour-filter');
const filterBtn = document.getElementById('filterBtn');
const clearBtn = document.getElementById('clearBtn');

function renderList(rows){
  listEl.innerHTML='';
  if(!rows.length){
    listEl.innerHTML=`<div style="padding:12px;color:#cfe">Nenhum agendamento (apenas reservas a partir das 19:00 são carregadas).</div>`;
    clearBlinkAll();
    return;
  }
  rows.forEach(r=>{
    const dt=parseSheetDateTime(r[0]);
    const hh = dt ? `${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}` : (r[0]||'');
    const solicit = r[1]||'';
    const ponto = r[2]||'';
    const key = bookingKey(r);
    const div = document.createElement('div'); div.className='item';
    div.innerHTML=`<div class="meta"><div class="hour">${hh}</div><div class="point">${ponto}</div><div class="name">${solicit}</div></div>
                   <div><button class="btn-confirm" data-key="${encodeURIComponent(key)}" style="background:#ff3b30;color:#fff;padding:8px 10px;border-radius:8px;border:none;font-weight:800">EMBARCAR</button></div>`;
    listEl.appendChild(div);
    div.querySelector('.btn-confirm').addEventListener('click',()=>confirmEmbarqueByKey(encodeURIComponent(key)));
  });
  setBlinkFor(rows.map(r=>r[2]));
}
function populateHourOptions(rows){
  const s = new Set();
  rows.forEach(r=>{
    const dt=parseSheetDateTime(r[0]);
    if(dt) s.add(`${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}`);
  });
  const arr=Array.from(s).sort();
  hourSelect.innerHTML='<option value="">Mostrar todos (≥19:00)</option>';
  arr.forEach(a=>{const opt=document.createElement('option'); opt.value=a; opt.textContent=a; hourSelect.appendChild(opt);});
}

/* ================== MAP ================== */
function initMap(){
  const desktopOverlay=document.getElementById('desktopOverlay');
  if(window.innerWidth>=900) desktopOverlay.style.display='flex'; else desktopOverlay.style.display='none';

  map=L.map('map').setView([-19.9978072,-43.9266727],15);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap contributors'}).addTo(map);

  pontos.forEach(p=>{
    const m=L.marker([p.coords.lat,p.coords.lng]).addTo(map).bindPopup(p.nome);
    markers[p.nome]=m;
  });

  loadBookings();
}
window.onload=initMap;

/* blink helpers */
function clearBlinkAll(){
  Object.values(markers).forEach(m=>{
    if(m._icon) m._icon.classList.remove('blink-alert');
  });
}
function setBlinkFor(names){
  clearBlinkAll();
  Object.keys(markers).forEach(k=>{
    if(!names.includes(k) && markers[k] && markers[k]._icon) markers[k]._icon.style.opacity=0.28;
  });
  names.forEach(n=>{
    const m=markers[n];
    if(!m || !m._icon) return;
    m._icon.classList.add('blink-alert');
    m._icon.style.cursor='pointer';
    m._icon.onclick=()=>{ const row=filteredData.find(r=>r[2]===n)||allData.find(r=>r[2]===n); if(row) confirmEmbarque(row); };
  });
}

/* ================== LOAD SHEETS ================== */
async function loadBookings(){
  try{
    const res = await fetch(SHEETS_URL);
    const json = await res.json();
    if(!json.values || json.values.length<=1){ allData=[]; filteredData=[]; renderList([]); return; }
    const rows=json.values.slice(1);
    const today=todayYMD();
    const kept = rows.filter(r=>{
      const dt=parseSheetDateTime(r[0]);
      if(!dt) return false;
      const rowYMD=`${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')}`;
      if(rowYMD!==today) return false;
      if(dt.getHours()<19) return false;
      if(embarcados.includes(bookingKey(r))) return false;
      return true;
    });
    allData=kept; filteredData=allData.slice();
    renderList(filteredData);
    populateHourOptions(allData);
    if(allData.length) speak(`${allData.length} agendamento(s) carregado(s).`);
    else speak('Nenhum agendamento a partir das 19 horas encontrado hoje.');
  }catch(e){ console.error(e); alert('Erro ao buscar dados da planilha.'); }
}

/* ================== FILTERS ================== */
filterBtn.addEventListener('click',()=>{
  const v=hourSelect.value;
  filteredData=!v ? allData.slice() : allData.filter(r=>{
    const dt=parseSheetDateTime(r[0]);
    if(!dt) return false;
    const hh=`${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}`;
    return hh===v;
  });
  renderList(filteredData);
});
clearBtn.addEventListener('click'=>{hourSelect.value=''; filteredData=allData.slice(); renderList(filteredData); clearBlinkAll();});

/* ================== EMBARQUE ================== */
function confirmEmbarque(row){
  const key=bookingKey(row);
  if(embarcados.includes(key)) return;
  embarcados.push(key);
  localStorage.setItem('embarcados_v3', JSON.stringify(embarcados));
  speak(`${row[1]} embarcado no ${row[2]}`);
  loadBookings();
}
function confirmEmbarqueByKey(key){
  key=decodeURIComponent(key);
  const row=allData.find(r=>bookingKey(r)===key);
  if(row) confirmEmbarque(row);
}

/* ================== FLOAT CONFIRM ================== */
const floatConfirm=document.getElementById('floatConfirm');
floatConfirm.addEventListener('click',()=>{
  speak('Embarque confirmado');
  floatConfirm.style.display='none';
});
</script>

</body>
</html>
