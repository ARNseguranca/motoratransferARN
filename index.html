<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Coleta Transfer Inauguração - Driver</title>

<!-- estilos mobile-first -->
<style>
  :root{
    --bg1:#05060a; --bg2:#0f1224; --accent:#00ffd5; --muted:rgba(255,255,255,0.06);
  }
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,var(--bg1),var(--bg2)); color:#eafffb; -webkit-font-smoothing:antialiased;}
  header{height:56px; position:fixed; left:0; right:0; top:0; z-index:9999; display:flex; align-items:center; gap:12px; padding:8px 12px; background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-bottom:1px solid rgba(255,255,255,0.02);}
  .logo{width:36px;height:36px;border-radius:8px;background:#fff;}
  .title{color:var(--accent); font-weight:700; font-size:17px;}
  #app{padding-top:56px; height:100vh; display:flex; overflow:hidden;}
  #map{flex:1; height:100%; min-height:200px;}
  #menu{position:fixed; left:-320px; top:56px; width:320px; height:calc(100% - 56px); background:rgba(0,0,0,0.92); overflow:auto; transition:0.28s; z-index:9999; padding:12px; box-sizing:border-box;}
  #menu.open{left:0;}
  .item{display:flex; justify-content:space-between; align-items:center; gap:8px; padding:10px; border-radius:10px; margin-bottom:8px; background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));}
  .meta{display:flex;flex-direction:column;}
  .hour{color:var(--accent); font-weight:900; font-size:14px;}
  .point{color:#dff; font-size:14px; margin-top:4px;}
  .name{color:#cfe; font-size:12px;}
  .btn{background:var(--accent); color:#000; border:none; padding:8px 12px; border-radius:10px; font-weight:800; cursor:pointer;}
  .btn-go{background:#00bfff;color:#000;}
  .btn-confirm{background:#ff3b30;color:#fff;}
  #menuToggle{position:fixed;top:8px;left:8px;z-index:10000;background:var(--accent);color:#000;padding:8px 12px;border:none;border-radius:8px;cursor:pointer;box-shadow:0 8px 20px rgba(0,0,0,0.4);}
  #desktopOverlay{display:none; position:fixed;inset:0; background:rgba(0,0,0,0.8); z-index:999998; align-items:center; justify-content:center;}
  #desktopOverlay .card{background:rgba(255,255,255,0.02); padding:18px;border-radius:12px; color:#fff; max-width:420px; text-align:center;}
  @media(min-width:900px){ #desktopOverlay{display:flex;} #map{filter:blur(3px);} }
  /* arrow overlay */
  #arrow{
    position:fixed; right:12px; bottom:110px; z-index:100000; width:72px; height:72px; background:rgba(0,0,0,0.55); border-radius:12px; display:flex; align-items:center; justify-content:center; box-shadow:0 8px 30px rgba(0,0,0,0.6);
    transform-origin:center center; transition:transform 0.25s linear;
  }
  #arrow svg{width:42px;height:42px; fill:var(--accent);}
  /* small status */
  #statusBubble{position:fixed;right:12px;bottom:24px;z-index:100000;background:rgba(0,0,0,0.6);padding:8px 12px;border-radius:10px;color:#cfe;font-weight:700;font-size:13px;}
  /* notification permission hint */
  .hint{font-size:12px;color:#9df;margin-top:6px;}
</style>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
</head>
<body>

<header>
  <div class="logo" aria-hidden="true"></div>
  <div class="title">Coleta Transfer Inauguração</div>
</header>

<button id="menuToggle" aria-label="Abrir menu">☰ Pontos</button>
<div id="menu" aria-hidden="true"></div>

<div id="app">
  <div id="map" role="application" aria-label="Mapa"></div>
</div>

<!-- arrow & status -->
<div id="arrow" title="Direção" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M12 2 L3 21 L12 17 L21 21 Z"></path></svg></div>
<div id="statusBubble">Aguardando</div>

<div id="desktopOverlay" aria-hidden="true">
  <div class="card">
    <h2 style="color:#00ffd5;margin:0 0 8px">Abra no celular</h2>
    <p style="color:#ddd;margin:0">Este painel foi otimizado como webapp de navegação para celular. Abra no navegador do seu celular para usar GPS e notificações.</p>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
/* ================== CONFIG ================== */
const SHEET_ID = "132fh2lxEE2vzpfBmAbYCsk4UtRJAZ6fjdLEplUqbwFc";
const SHEETS_API_KEY = "AIzaSyCkkBqKGxqPsBHK4-tQN_8DhdNMmX4gaqU";
const RANGE = "A:E";
const SHEETS_URL = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${SHEETS_API_KEY}`;

/* ================== ESTADO ================== */
let allData = [], filteredData = [], embarcados = JSON.parse(localStorage.getItem('embarcados_v3') || '[]');
let map, driverMarker, routeLayer, currentDest = null;
let watchId = null;
let ultimaAtualizacao = 0; // timestamp ms da última linha conhecida
const POLL_INTERVAL_MS = 15000; // 15s

const menu = document.getElementById('menu');
const menuToggle = document.getElementById('menuToggle');
const arrowEl = document.getElementById('arrow');
const statusBubble = document.getElementById('statusBubble');

/* ================== PONTOS FIXOS ================== */
const pontos = [
  {nome:"PORTARIA", coords:[-19.9978072,-43.9266727]},
  {nome:"Ponto 30", coords:[-19.9977078,-43.9289372]},
  {nome:"Ponto 28", coords:[-19.9986592,-43.9306448]},
  {nome:"Ponto 29", coords:[-19.999421,-43.9326796]},
  {nome:"Ponto 27", coords:[-20.0002531,-43.9314901]},
  {nome:"Ponto 26", coords:[-20.0015469,-43.9333477]},
  {nome:"Ponto 24", coords:[-20.003258,-43.9296246]},
  {nome:"Ponto 25", coords:[-20.0050238,-43.9308419]},
  {nome:"Ponto 21", coords:[-20.0027213,-43.9338594]},
  {nome:"Ponto 22", coords:[-20.001474,-43.9355339]},
  {nome:"Ponto 23", coords:[-20.0031588,-43.9364208]},
  {nome:"Ponto 20", coords:[-20.0063663,-43.934352]},
  {nome:"Ponto 19", coords:[-20.0085746,-43.9318072]},
  {nome:"Ponto 17", coords:[-20.0104645,-43.9320381]},
  {nome:"Ponto 18", coords:[-20.0088433,-43.9343321]},
  {nome:"Ponto 12", coords:[-20.0088434,-43.9288248]},
  {nome:"Ponto 13", coords:[-20.0094456,-43.9269802]},
  {nome:"Ponto 14", coords:[-20.0075172,-43.9277972]},
  {nome:"Ponto 16", coords:[-20.0068404,-43.9290337]},
  {nome:"Ponto 15", coords:[-20.0079616,-43.9293497]},
  {nome:"Ponto 09", coords:[-20.0110997,-43.9309597]},
  {nome:"Ponto 10", coords:[-20.0120307,-43.9334509]},
  {nome:"Ponto 11", coords:[-20.0098192,-43.9337648]},
  {nome:"Ponto 08", coords:[-20.0102615,-43.9273848]},
  {nome:"Ponto 05", coords:[-20.0114455,-43.9257426]},
  {nome:"Ponto 06", coords:[-20.0112228,-43.9276231]},
  {nome:"Ponto 07", coords:[-20.0108785,-43.9296971]},
  {nome:"Ponto 04", coords:[-20.0068997,-43.9238609]},
  {nome:"Ponto 03", coords:[-20.0047577,-43.9260624]},
  {nome:"Ponto 02", coords:[-20.001753,-43.9270223]}
];

/* ================== UTIL ================== */
function todayYMD(){ const n = new Date(); return `${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}-${String(n.getDate()).padStart(2,'0')}`; }

function parseSheetDateTime(val){
  // aceita DD/MM/YYYY HH:MM ou ISO
  if(!val) return null;
  if(val.includes('/')){
    const [dpart, tpart='00:00'] = val.split(' ');
    const [d,m,y] = dpart.split('/');
    const [hh,mm] = tpart.split(':');
    const dt = new Date(Number(y), Number(m)-1, Number(d), Number(hh||0), Number(mm||0));
    return isNaN(dt) ? null : dt;
  }
  const dt = new Date(val);
  return isNaN(dt) ? null : dt;
}

function bookingKey(row){
  return `${(row[1]||'').trim()}___${(row[2]||'').trim()}___${(row[0]||'').trim()}`;
}

/* WebAudio beep (no external file) */
const audioCtx = (window.AudioContext || window.webkitAudioContext) ? new (window.AudioContext || window.webkitAudioContext)() : null;
function playBeep(){
  if(!audioCtx) return;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = 'sine';
  o.frequency.value = 880;
  o.connect(g);
  g.connect(audioCtx.destination);
  g.gain.setValueAtTime(0.0001, audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.2, audioCtx.currentTime + 0.01);
  o.start();
  g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.45);
  setTimeout(()=>{ o.stop(); }, 500);
}

/* simple speak wrapper */
function speak(text){
  if('speechSynthesis' in window){
    try {
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'pt-BR';
      u.rate = 1;
      window.speechSynthesis.speak(u);
      return;
    } catch(e){ console.warn('speak err', e); }
  }
  // fallback: small beep
  playBeep();
}

/* bearing between two latlng arrays */
function bearingBetween(a, b){
  // a and b as [lat, lon]
  const toRad = Math.PI/180, toDeg = 180/Math.PI;
  const lat1 = a[0]*toRad, lat2 = b[0]*toRad;
  const dLon = (b[1]-a[1])*toRad;
  const y = Math.sin(dLon)*Math.cos(lat2);
  const x = Math.cos(lat1)*Math.sin(lat2) - Math.sin(lat1)*Math.cos(lat2)*Math.cos(dLon);
  let brng = Math.atan2(y,x)*toDeg;
  brng = (brng + 360) % 360;
  return brng; // degrees from north
}

/* ================== UI MENU ================== */
function renderMenu(rows){
  menu.innerHTML = '';
  if(!rows.length){
    const no = document.createElement('div');
    no.style.padding = '12px';
    no.style.color = '#cfe';
    no.textContent = 'Nenhum agendamento disponível (apenas reservas ≥ 19:00).';
    menu.appendChild(no);
    return;
  }
  rows.forEach(r=>{
    const dt = parseSheetDateTime(r[0]);
    const hh = dt ? `${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}` : '';
    const div = document.createElement('div');
    div.className = 'item';
    div.innerHTML = `<div class="meta"><div class="hour">${hh}</div><div class="point">${r[2]||''}</div><div class="name">${r[1]||''}</div></div>
      <div><button class="btn btn-go" data-key="${encodeURIComponent(bookingKey(r))}">Ir</button></div>`;
    menu.appendChild(div);
    div.querySelector('.btn-go').addEventListener('click', ()=> startNavigationTo(r));
  });
}

/* menu toggle */
menuToggle.addEventListener('click', ()=>{
  menu.classList.toggle('open');
  // hint: request notifications if not yet
  if('Notification' in window && Notification.permission === 'default'){
    Notification.requestPermission().catch(()=>{});
  }
});

/* ================== MAP INIT ================== */
map = L.map('map', { zoomControl: true }).setView([-19.9978072, -43.9266727], 15);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap contributors' }).addTo(map);
routeLayer = L.layerGroup().addTo(map);

/* car icon */
const carIcon = L.icon({
  iconUrl: 'https://cdn-icons-png.flaticon.com/512/61/61168.png',
  iconSize: [44,44],
  iconAnchor: [22,22]
});

/* driver rotation helper */
function rotateMarkerIcon(marker, angleDegrees){
  if(!marker || !marker._icon) return;
  marker._icon.style.transform = `rotate(${angleDegrees}deg) translate(-50%, -50%)`;
  marker._icon.style.transition = 'transform 0.2s linear';
}

/* ================== LOADING BOOKINGS ================== */
async function loadBookings(initial=false){
  try {
    const res = await fetch(SHEETS_URL);
    const json = await res.json();
    if(!json || !json.values || json.values.length <= 1){
      allData = []; filteredData = [];
      renderMenu(filteredData);
      return;
    }
    const rows = json.values.slice(1);
    const today = todayYMD();

    // determine max timestamp present to initialize ultimaAtualizacao
    let maxTimestamp = ultimaAtualizacao;

    // keep rows for today, >=19:00, not embarcados
    const kept = rows.filter(r=>{
      const dt = parseSheetDateTime(r[0]);
      if(!dt) return false;
      const yyyy = dt.getFullYear(), mm = String(dt.getMonth()+1).padStart(2,'0'), dd = String(dt.getDate()).padStart(2,'0');
      const rowYMD = `${yyyy}-${mm}-${dd}`;
      if(rowYMD !== today) return false;
      if(dt.getHours() < 19) return false;
      const key = bookingKey(r);
      if(embarcados.includes(key)) return false;
      // update maxTimestamp
      if(dt.getTime() > maxTimestamp) maxTimestamp = dt.getTime();
      return true;
    });

    // detect new items (only when not initial load)
    if(!initial && ultimaAtualizacao > 0){
      const novas = kept.filter(r=>{
        const dt = parseSheetDateTime(r[0]);
        return dt && dt.getTime() > ultimaAtualizacao;
      });
      if(novas.length > 0){
        // play beep + notification
        novas.forEach(n=>{
          const solicit = n[1]||'';
          const ponto = n[2]||'';
          notifyNewBooking(`Novo agendamento: ${solicit} - ${ponto}`);
        });
      }
    }

    allData = kept;
    filteredData = allData.slice();
    renderMenu(filteredData);

    // update ultimaAtualizacao to the max found (or now if none)
    if(maxTimestamp > 0) ultimaAtualizacao = maxTimestamp;
    else if(initial && rows.length > 0){
      // set to now to avoid immediate notifications on first load
      ultimaAtualizacao = Date.now();
    }
  } catch (e){
    console.error('Erro ao buscar planilha', e);
  }
}

/* initial load */
loadBookings(true);

/* poll for new bookings */
setInterval(()=> loadBookings(false), POLL_INTERVAL_MS);

/* notification + beep */
async function notifyNewBooking(message){
  // beep
  playBeep();
  // push notification
  if('Notification' in window && Notification.permission === 'granted'){
    try {
      const n = new Notification('Nova marcação', { body: message, icon: 'https://cdn-icons-png.flaticon.com/512/61/61168.png' });
      // optional: when clicked, open menu
      n.onclick = ()=> { window.focus(); menu.classList.add('open'); };
    } catch(e){ console.warn('notify err', e); }
  } else {
    // show a small in-app status bubble
    statusBubble.textContent = message;
    setTimeout(()=> { statusBubble.textContent = 'Aguardando'; }, 5000);
  }
}

/* ================== ROUTING (OSRM) ================== */
async function getRouteOSRM(start, end){
  try{
    // start and end as [lat, lon]
    const url = `https://router.project-osrm.org/route/v1/driving/${start[1]},${start[0]};${end[1]},${end[0]}?overview=full&geometries=geojson&steps=true`;
    const res = await fetch(url);
    const data = await res.json();
    if(data && data.routes && data.routes[0]){
      const coords = data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]); // convert to [lat,lon]
      // try to extract maneuvers or steps for direction guidance (OSRM returns legs[].steps)
      let maneuvers = [];
      try {
        data.routes[0].legs.forEach(leg => {
          leg.steps.forEach(s => {
            maneuvers.push({
              instruction: s.name || (s.maneuver && s.maneuver.type) || '',
              location: [s.maneuver.location[1], s.maneuver.location[0]]
            });
          });
        });
      } catch(e){ maneuvers = []; }
      return { coords, maneuvers };
    }
    return null;
  } catch(e){
    console.error('OSRM error', e);
    return null;
  }
}

/* ================== NAVIGATION ================== */
let currentRoute = []; // array of [lat,lon]
let nextIndex = 0;

async function startNavigationTo(row){
  // close menu for driving
  menu.classList.remove('open');

  currentDest = pontos.find(p => p.nome === row[2]);
  if(!currentDest){ alert('Destino inválido'); return; }

  // ask for permission for notifications proactively
  if('Notification' in window && Notification.permission === 'default'){
    try { await Notification.requestPermission(); } catch(e) { /* ignore */ }
  }

  if(watchId) navigator.geolocation.clearWatch(watchId);

  // start watching
  watchId = navigator.geolocation.watchPosition(async pos => {
    const latlng = [pos.coords.latitude, pos.coords.longitude];

    // update driver marker
    if(!driverMarker){
      driverMarker = L.marker(latlng, { icon: carIcon }).addTo(map);
    } else {
      driverMarker.setLatLng(latlng);
    }

    // compute route each update (or you can debounce)
    const route = await getRouteOSRM(latlng, currentDest.coords);
    if(route && route.coords && route.coords.length){
      currentRoute = route.coords;
      // draw route
      routeLayer.clearLayers();
      L.polyline(currentRoute, { color: '#00ffd5', weight: 6 }).addTo(routeLayer);
      // fit bounds but keep zoom reasonable
      try {
        const fg = L.featureGroup([driverMarker, L.marker(currentDest.coords)]);
        map.fitBounds(fg.getBounds().pad(0.2));
      } catch(e){ /* ignore */ }
      // pick look-ahead point for arrow guidance
      const lookAhead = pickLookAheadPoint(latlng, currentRoute);
      if(lookAhead){
        const brng = bearingBetween(latlng, lookAhead); // degrees
        // rotate arrow UI (Leaflet uses north-up; arrow pointing up means go ahead)
        arrowEl.style.transform = `rotate(${brng}deg)`;
        arrowEl.style.display = 'flex';
        statusBubble.textContent = `Destino: ${row[2]} • ${Math.round(distanceMeters(latlng, currentDest.coords))} m`;
        // rotate car icon visually
        rotateMarkerIcon(driverMarker, brng);
      }
    }

    // proximity check to change button to confirm
    const dist = distanceMeters(latlng, currentDest.coords);
    if(dist < 45){
      // find corresponding menu button (if exists) and turn to confirm
      const btn = document.querySelector(`button[data-key="${encodeURIComponent(bookingKey(row))}"]`);
      if(btn){
        btn.textContent = 'Confirmar Embarque';
        btn.className = 'btn btn-confirm';
        btn.onclick = () => confirmEmbarque(row);
        // show a quick speak
        speak('Você chegou ao ponto. Confirme o embarque.');
      } else {
        // if menu not open and button not in DOM, show a small overlay
        statusBubble.textContent = 'Chegou ao ponto — confirme embarque';
      }
    }

  }, err => {
    console.warn('geo error', err);
    alert('Erro ao obter localização. Verifique permissões do navegador.');
  }, { enableHighAccuracy: true, maximumAge: 1000, timeout: 7000 });
}

/* pick a point ahead in the route to compute bearing */
function pickLookAheadPoint(current, routeCoords){
  if(!routeCoords || routeCoords.length === 0) return null;
  // find nearest index
  let nearest = 0;
  let minD = Infinity;
  for(let i=0;i<routeCoords.length;i++){
    const d = haversine(current, routeCoords[i]);
    if(d < minD){ minD = d; nearest = i; }
  }
  // pick a point 6-10 indices ahead, bounded
  const lookIndex = Math.min(routeCoords.length-1, nearest + 6);
  return routeCoords[lookIndex];
}

/* distance helpers */
function haversine(a,b){
  // return meters
  const R = 6371000;
  const toRad = Math.PI/180;
  const dLat = (b[0]-a[0]) * toRad;
  const dLon = (b[1]-a[1]) * toRad;
  const lat1 = a[0]*toRad, lat2 = b[0]*toRad;
  const s = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(s));
}
function distanceMeters(a,b){ return Math.round(haversine(a,b)); }

/* ================== CONFIRMAR EMBARQUE ================== */
function confirmEmbarque(row){
  const key = bookingKey(row);
  if(!embarcados.includes(key)) embarcados.push(key);
  localStorage.setItem('embarcados_v3', JSON.stringify(embarcados));
  // remove from lists and re-render menu
  allData = allData.filter(r => bookingKey(r) !== key);
  filteredData = filteredData.filter(r => bookingKey(r) !== key);
  renderMenu(filteredData);
  // clear route & stop watch if no more
  routeLayer.clearLayers();
  currentDest = null;
  if(watchId){ navigator.geolocation.clearWatch(watchId); watchId = null; }
  speak('Embarque confirmado');
  statusBubble.textContent = 'Embarque confirmado';
  setTimeout(()=> statusBubble.textContent = 'Aguardando', 3000);
}

/* ================== POLL FOR NEW BOOKINGS (improved) ================== */
/* This is handled by loadBookings() + internal ultimaAtualizacao logic above */

/* ================== STARTUP UI & PERMISSIONS ================== */
/* If on desktop, show overlay */
if(window.innerWidth >= 900){
  document.getElementById('desktopOverlay').style.display = 'flex';
} else {
  document.getElementById('desktopOverlay').style.display = 'none';
}

/* Ask notification permission early (optional) */
if('Notification' in window && Notification.permission === 'default'){
  Notification.requestPermission().catch(()=>{});
}

/* Optional: small helper to re-check sheet on pull-down or manual refresh */
// Add long-press or double-tap in menu title? For now user reloads page

</script>
</body>
</html>
