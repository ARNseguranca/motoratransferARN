<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#05060a">
<title>Coleta Transfer Inauguração - Driver (Mobile)</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css"/>

<style>
  :root{
    --bg1:#05060a; --bg2:#0f1224; --accent:#00ffd5; --muted:rgba(255,255,255,0.06);
    --touch:18px;
  }
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,var(--bg1),var(--bg2)); color:#eafffb; -webkit-font-smoothing:antialiased; -webkit-touch-callout:none; -webkit-user-select:none;}
  header{height:56px; position:fixed; left:0; right:0; top:0; z-index:9999; display:flex; align-items:center; gap:12px; padding:8px 12px; background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-bottom:1px solid rgba(255,255,255,0.02);}
  .logo{width:36px;height:36px;border-radius:8px;background:#fff;}
  .title{color:var(--accent); font-weight:700; font-size:17px;}
  #app{padding-top:56px; height:100vh; display:flex; overflow:hidden;}
  #map{flex:1; height:100%; min-height:200px; touch-action: none;}
  #menu{position:fixed; left:-100%; top:56px; width:92%; max-width:360px; height:calc(100% - 56px); background:rgba(0,0,0,0.95); overflow:auto; transition:0.28s; z-index:9999; padding:12px; box-sizing:border-box; border-top-right-radius:12px; border-bottom-right-radius:12px;}
  #menu.open{left:0;}
  .item{display:flex; justify-content:space-between; align-items:center; gap:8px; padding:12px; border-radius:12px; margin-bottom:10px; background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));}
  .meta{display:flex;flex-direction:column;}
  .hour{color:var(--accent); font-weight:900; font-size:16px;}
  .point{color:#dff; font-size:16px; margin-top:6px;}
  .name{color:#cfe; font-size:14px;}
  .btn{background:var(--accent); color:#000; border:none; padding:12px 16px; border-radius:12px; font-weight:800; cursor:pointer; font-size:16px;}
  .btn-go{background:#00bfff;color:#000;}
  .btn-confirm{background:#ff3b30;color:#fff; padding:12px 18px;}
  #menuToggle{position:fixed;top:10px;left:10px;z-index:10000;background:var(--accent);color:#000;padding:10px 14px;border:none;border-radius:12px;cursor:pointer;box-shadow:0 8px 20px rgba(0,0,0,0.4); font-weight:900;}
  #arrow{position:fixed; right:12px; bottom:110px; z-index:100000; width:64px; height:64px; background:rgba(0,0,0,0.55); border-radius:12px; display:flex; align-items:center; justify-content:center; box-shadow:0 8px 30px rgba(0,0,0,0.6); transform-origin:center center; transition:transform 0.25s linear;}
  #arrow svg{width:34px;height:34px; fill:var(--accent);}
  #statusBubble{position:fixed;right:12px;bottom:24px;z-index:100000;background:rgba(0,0,0,0.6);padding:10px 14px;border-radius:12px;color:#cfe;font-weight:800;font-size:15px;}
  #newAlert{position:fixed; top:88px; right:8px; left:8px; max-width:420px; margin:auto;background:#ff3b30; color:#fff; padding:14px 14px; border-radius:12px; font-weight:800; z-index:100001; display:none; box-shadow:0 12px 40px rgba(0,0,0,0.6);}
  #newAlert .msg{display:block; margin-bottom:10px; font-size:16px; animation:pulse 1s infinite;}
  @keyframes pulse { 0%{opacity:1}50%{opacity:0.6}100%{opacity:1} }
  .sliderWrap{height:44px; background:rgba(255,255,255,0.06); border-radius:10px; display:flex; align-items:center; position:relative; overflow:hidden; user-select:none;}
  .sliderText{position:absolute; left:12px; top:0; bottom:0; display:flex; align-items:center; pointer-events:none; color:#fff; font-weight:800; font-size:15px;}
  .sliderHandle{width:48px; height:36px; background:#000; border-radius:10px; margin-left:6px; display:flex; align-items:center; justify-content:center; cursor:grab; font-weight:900;}
  .sliderBar{flex:1; height:100%; display:flex; align-items:center; padding-right:8px; padding-left:72px;}
  #newAlert button.simpleClose{ margin-left:8px;background:transparent;border:1px solid rgba(255,255,255,0.18); color:#fff; padding:8px 10px; border-radius:8px; cursor:pointer;}
  #confirmBtn{position:fixed;bottom:110px;left:50%;transform:translateX(-50%);z-index:100002;display:none;padding:12px 18px;border-radius:12px;border:none;background:#ff3b30;color:#fff;font-weight:900;cursor:pointer;font-size:16px;}
  #desktopOverlay{display:flex; position:fixed;inset:0; background:linear-gradient(180deg, rgba(0,0,0,0.9), rgba(0,0,0,0.85)); z-index:100003; align-items:center; justify-content:center; gap:10px; flex-direction:column; padding:20px;}
  .card{background:rgba(255,255,255,0.03); padding:22px;border-radius:12px; color:#fff; width:100%; max-width:420px; text-align:center;}
  .card button{margin-top:12px;padding:12px 16px;border-radius:12px;border:none;background:var(--accent);color:#000;font-weight:900;cursor:pointer; font-size:16px;}
  .card button.secondary{background:#444;color:#fff;margin-top:8px;}
  @media (min-width:900px){
    #menu{left:-320px; width:320px;}
    #newAlert{right:12px; left:auto; width:340px;}
    #desktopOverlay{display:none;}
  }
</style>
</head>
<body>

<header>
  <div class="logo" aria-hidden="true"></div>
  <div class="title">Coleta Transfer Inauguração</div>
</header>

<button id="menuToggle" aria-label="Abrir menu">☰ Pontos</button>
<div id="menu" aria-hidden="true"></div>

<div id="app"><div id="map" role="application" aria-label="Mapa"></div></div>

<div id="arrow" title="Direção" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M12 2 L3 21 L12 17 L21 21 Z"></path></svg></div>
<div id="statusBubble">Aguardando</div>

<div id="newAlert">
  <span class="msg" id="alertText"></span>
  <div class="sliderWrap" id="sliderWrap" style="margin-bottom:10px">
    <div class="sliderText">Arraste para fechar →</div>
    <div class="sliderBar"><div class="sliderHandle" id="sliderHandle">≫</div></div>
  </div>
  <div style="display:flex;justify-content:flex-end;">
    <button class="simpleClose" id="simpleCloseBtn">Fechar</button>
  </div>
</div>

<button id="confirmBtn" class="btn-confirm">Confirmar embarque</button>

<div id="desktopOverlay" aria-hidden="false">
  <div class="card">
    <h2 style="color:#00ffd5;margin:0 0 8px">Bem-vindo</h2>
    <p style="color:#ddd;margin:0">Toque em <strong>Iniciar</strong> para ativar GPS, audio e notificações (necessário para o WebApp funcionar corretamente no celular).</p>
    <button id="grantPermissionsBtn">Iniciar</button>
    <button id="skipPermissionsBtn" class="secondary">Continuar sem permissões</button>
  </div>
</div>

<!-- libs -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<script>
/* ================== CONFIG ================== */
const SHEET_ID = "132fh2lxEE2vzpfBmAbYCsk4UtRJAZ6fjdLEplUqbwFc";
const SHEETS_API_KEY = "AIzaSyCkkBqKGxqPsBHK4-tQN_8DhdNMmX4gaqU";
const RANGE = "A:E";
const SHEETS_URL = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${SHEETS_API_KEY}`;

const POLL_INTERVAL_MS = 12000;
const ULT_KEY = 'ultimaAtualizacao_mobile_v1';
const EMBARCADOS_KEY = 'embarcados_v3';
const SEEN_KEY = 'seen_requests_mobile_v1';
const SKIPPED_PERMS_KEY = 'skip_perms_mobile_v1';

/* ================== STATE ================== */
let allData = [], filteredData = [];
let embarcados = JSON.parse(localStorage.getItem(EMBARCADOS_KEY) || '[]');
let ultimaAtualizacao = Number(localStorage.getItem(ULT_KEY) || '0');
let seenRequests = new Set(JSON.parse(localStorage.getItem(SEEN_KEY) || '[]'));
let newAlerts = [];

let map, driverMarker=null, routeControl=null, currentDest=null, destMarker=null;
let watchId = null, initialLoaded=false;

/* ================== DOM ================== */
const menu = document.getElementById('menu');
const menuToggle = document.getElementById('menuToggle');
const arrowEl = document.getElementById('arrow');
const statusBubble = document.getElementById('statusBubble');
const newAlertEl = document.getElementById('newAlert');
const alertText = document.getElementById('alertText');
const sliderHandle = document.getElementById('sliderHandle');
const sliderWrap = document.getElementById('sliderWrap');
const simpleCloseBtn = document.getElementById('simpleCloseBtn');
const confirmBtn = document.getElementById('confirmBtn');
const desktopOverlay = document.getElementById('desktopOverlay');
const grantPermissionsBtn = document.getElementById('grantPermissionsBtn');
const skipPermissionsBtn = document.getElementById('skipPermissionsBtn');

/* ================== PONTOS ================== */
const pontos = [
  {nome:"PORTARIA", coords:[-19.9978072,-43.9266727]},
  {nome:"Ponto 30", coords:[-19.9977078,-43.9289372]},
  {nome:"Ponto 28", coords:[-19.9986592,-43.9306448]},
  {nome:"Ponto 29", coords:[-19.999421,-43.9326796]},
  {nome:"Ponto 27", coords:[-20.0002531,-43.9314901]},
  {nome:"Ponto 26", coords:[-20.0015469,-43.9333477]},
  {nome:"Ponto 24", coords:[-20.003258,-43.9296246]},
  {nome:"Ponto 25", coords:[-20.0050238,-43.9308419]},
  {nome:"Ponto 21", coords:[-20.0027213,-43.9338594]},
  {nome:"Ponto 22", coords:[-20.001474,-43.9355339]},
  {nome:"Ponto 23", coords:[-20.0031588,-43.9364208]},
  {nome:"Ponto 20", coords:[-20.0063663,-43.934352]},
  {nome:"Ponto 19", coords:[-20.0085746,-43.9318072]},
  {nome:"Ponto 17", coords:[-20.0104645,-43.9320381]},
  {nome:"Ponto 18", coords:[-20.0088433,-43.9343321]},
  {nome:"Ponto 12", coords:[-20.0088434,-43.9288248]},
  {nome:"Ponto 13", coords:[-20.0094456,-43.9269802]},
  {nome:"Ponto 14", coords:[-20.0075172,-43.9277972]},
  {nome:"Ponto 16", coords:[-20.0068404,-43.9290337]},
  {nome:"Ponto 15", coords:[-20.0079616,-43.9293497]},
  {nome:"Ponto 09", coords:[-20.0110997,-43.9309597]},
  {nome:"Ponto 10", coords:[-20.0120307,-43.9334509]},
  {nome:"Ponto 11", coords:[-20.0098192,-43.9337648]},
  {nome:"Ponto 08", coords:[-20.0102615,-43.9273848]},
  {nome:"Ponto 05", coords:[-20.0114455,-43.9257426]},
  {nome:"Ponto 06", coords:[-20.0112228,-43.9276231]},
  {nome:"Ponto 07", coords:[-20.0108785,-43.9296971]},
  {nome:"Ponto 04", coords:[-20.0068997,-43.9238609]},
  {nome:"Ponto 03", coords:[-20.0047577,-43.9260624]},
  {nome:"Ponto 02", coords:[-20.001753,-43.9270223]}
];

/* ================== HELPERS ================== */
function todayYMD(){ const n=new Date(); return `${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}-${String(n.getDate()).padStart(2,'0')}`; }
function parseSheetDateTime(val){
  if(!val) return null;
  if(val.includes('/')){
    const [dpart,tpart='00:00'] = val.split(' ');
    const [d,m,y] = dpart.split('/');
    const [hh,mm] = tpart.split(':');
    const dt = new Date(Number(y),Number(m)-1,Number(d),Number(hh||0),Number(mm||0));
    return isNaN(dt)?null:dt;
  }
  const dt = new Date(val); return isNaN(dt)?null:dt;
}
function bookingKey(row){ return `${(row[1]||'').trim()}___${(row[2]||'').trim()}___${(row[0]||'').trim()}___${(row[3]||'')}`; }

/* ================== MAP INIT ================== */
map = L.map('map', { zoomControl: false, attributionControl:false }).setView([-19.9978072, -43.9266727], 15);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

/* ============ CAR ICON ============ */
const carIconUrl = 'carro.png';
const carIcon = L.icon({ iconUrl: carIconUrl, iconSize:[48,48], iconAnchor:[24,24] });

function rotateMarkerIcon(marker, angleDegrees){
  if(!marker||!marker._icon) return;
  marker._icon.style.transform = `rotate(${angleDegrees}deg) translate(-50%, -50%)`;
  marker._icon.style.transition = 'transform 0.18s linear';
}

/* ================== AUDIO / VOICE ========== */
let beepInterval = null;
const audioCtx = (window.AudioContext||window.webkitAudioContext) ? new (window.AudioContext||window.webkitAudioContext)() : null;

function playBeepOnce(){
  if(!audioCtx) return;
  try{ audioCtx.resume?.(); }catch(e){}
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type='sine'; o.frequency.value=880;
  o.connect(g); g.connect(audioCtx.destination);
  g.gain.setValueAtTime(0.0001, audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.18, audioCtx.currentTime+0.01);
  o.start();
  g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime+0.45);
  setTimeout(()=>{ try{o.stop();}catch(e){} }, 500);
}
function startAlertBeep(){ if(beepInterval) return; playBeepOnce(); beepInterval = setInterval(playBeepOnce, 1200); }
function stopAlertBeep(){ if(beepInterval){ clearInterval(beepInterval); beepInterval = null; } }
function speak(text){
  if('speechSynthesis' in window){
    try{ window.speechSynthesis.cancel(); const u=new SpeechSynthesisUtterance(text); u.lang='pt-BR'; window.speechSynthesis.speak(u); }catch(e){ console.warn(e); }
  }
}

/* ================== ALERT UI (touch slider) ========== */
let dragging=false, startX=0, handleMax=0;
function openNewAlert(message){
  newAlerts.push(message);
  alertText.textContent = newAlerts.length === 1 ? message : `${newAlerts.length} novas marcações`;
  newAlertEl.style.display = 'block';
  startAlertBeep();
  speak('Nova solicitação de transporte');
  notifyNative('Nova marcação', message.replace(/^Novo agendamento:\s*/, ''));
  sliderHandle.style.transform = 'translateX(0px)';
  setTimeout(()=>{ handleMax = Math.max(80, sliderWrap.clientWidth - sliderHandle.clientWidth - 12); }, 160);
}
function clearNewAlerts(){
  newAlerts = [];
  alertText.textContent = '';
  newAlertEl.style.display = 'none';
  stopAlertBeep();
}

/* slider handlers for mobile */
sliderHandle.addEventListener('pointerdown', (e)=>{
  dragging=true; startX = e.clientX; sliderHandle.setPointerCapture(e.pointerId); sliderHandle.style.cursor='grabbing';
});
window.addEventListener('pointermove', (e)=>{
  if(!dragging) return;
  const dx = e.clientX - startX;
  const x = Math.max(0, Math.min(handleMax||200, dx));
  sliderHandle.style.transform = `translateX(${x}px)`;
});
window.addEventListener('pointerup', (e)=>{
  if(!dragging) return;
  dragging=false; sliderHandle.style.cursor='grab';
  const dx = e.clientX - startX;
  if(dx >= (handleMax*0.70 || 120)){
    clearNewAlerts();
  } else {
    sliderHandle.style.transition='transform 200ms'; sliderHandle.style.transform='translateX(0px)';
    setTimeout(()=>{ sliderHandle.style.transition=''; },220);
  }
});
simpleCloseBtn.addEventListener('click', ()=> clearNewAlerts());

/* ================== NOTIFICAÇÕES NATIVAS ========== */
async function requestNotificationPermissionOnce(){
  if(!('Notification' in window)) return false;
  if(Notification.permission === 'default' && !localStorage.getItem(SKIPPED_PERMS_KEY)){
    try{ const p = await Notification.requestPermission(); return p === 'granted'; }catch(e){ return false; }
  }
  return Notification.permission === 'granted';
}
async function notifyNative(title, body){
  if(!('Notification' in window)) return;
  if(Notification.permission === 'granted'){
    try{ const n = new Notification(title, { body, icon: carIconUrl }); n.onclick = ()=>{ window.focus(); menu.classList.add('open'); }; }catch(e){ console.warn(e); }
  }
}

/* ================== LOAD BOOKINGS (Sheets) ========== */
async function loadBookings(initial=false){
  try{
    const res = await fetch(SHEETS_URL);
    const json = await res.json();
    if(!json || !json.values || json.values.length <= 1){ allData=[]; filteredData=[]; renderMenu(filteredData); return; }
    const rows = json.values.slice(1);
    const today = todayYMD();
    let maxTimestamp = ultimaAtualizacao || 0;

    const kept = rows.filter(r=>{
      const dt = parseSheetDateTime(r[0]);
      if(!dt) return false;
      const rowYMD = `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')}`;
      if(rowYMD !== today) return false;
      if(dt.getHours() < 19) return false;
      const key = bookingKey(r);
      if(embarcados.includes(key)) return false;
      if(dt.getTime() > maxTimestamp) maxTimestamp = dt.getTime();
      return true;
    });

    // Detect new rows: if already loaded once, notify every unseen row
    if(initialLoaded){
      kept.forEach(row => {
        const key = bookingKey(row);
        if(!seenRequests.has(key)){
          seenRequests.add(key);
          try{ localStorage.setItem(SEEN_KEY, JSON.stringify(Array.from(seenRequests))); }catch(e){}
          const solicitante = row[1] || '';
          const ponto = row[2] || '';
          openNewAlert(`Novo agendamento: ${solicitante} - ${ponto}`);
        }
      });
    } else {
      // mark present rows as seen on first load (no notifications)
      kept.forEach(row => {
        const key = bookingKey(row);
        if(!seenRequests.has(key)) seenRequests.add(key);
      });
      try{ localStorage.setItem(SEEN_KEY, JSON.stringify(Array.from(seenRequests))); }catch(e){}
    }

    allData = kept;
    filteredData = allData.slice();
    renderMenu(filteredData);

    ultimaAtualizacao = maxTimestamp > 0 ? maxTimestamp : ultimaAtualizacao;
    localStorage.setItem(ULT_KEY, String(ultimaAtualizacao || 0));
    initialLoaded = true;

  }catch(e){
    console.error('Erro ao carregar planilha', e);
  }
}

/* ================== RENDER MENU (touch friendly) ========== */
function renderMenu(rows){
  menu.innerHTML = '';
  if(!rows || rows.length === 0){
    const no = document.createElement('div'); no.style.padding='14px'; no.style.color='#cfe';
    no.textContent='Nenhum agendamento disponível (apenas reservas ≥ 19:00).';
    menu.appendChild(no); return;
  }
  rows.forEach(r=>{
    const dt = parseSheetDateTime(r[0]);
    const hh = dt ? `${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}` : '';
    const div = document.createElement('div'); div.className='item';
    div.innerHTML = `<div class="meta"><div class="hour">${hh}</div><div class="point">${r[2]||''}</div><div class="name">${r[1]||''}</div></div>
      <div><button class="btn btn-go">Ir</button></div>`;
    menu.appendChild(div);
    div.querySelector('.btn-go').addEventListener('click', ()=> startNavigationTo(r));
  });
}

/* ================== NAVIGATION (OSRM routing) ========== */
function startNavigationTo(row){
  const nomePonto = (row[2]||'').trim().toLowerCase();
  currentDest = pontos.find(p=>p.nome.toLowerCase() === nomePonto);
  if(!currentDest){ alert('Ponto não encontrado no mapa: '+row[2]); return; }

  speak(`Indo para ${currentDest.nome}`);
  statusBubble.textContent = `Indo para ${currentDest.nome}`;
  menu.classList.remove('open');

  if(routeControl){ try{ routeControl.remove(); }catch(e){} routeControl = null; }
  if(destMarker){ try{ map.removeLayer(destMarker); }catch(e){} destMarker = null; }

  destMarker = L.marker(currentDest.coords).addTo(map).bindPopup(`<b>${currentDest.nome}</b>`);

  if(driverMarker){
    const from = driverMarker.getLatLng();
    const to = L.latLng(currentDest.coords[0], currentDest.coords[1]);
    routeControl = L.Routing.control({
      waypoints: [ from, to ],
      routeWhileDragging:false,
      show:false,
      addWaypoints:false,
      createMarker: ()=>null,
      lineOptions:{ styles:[{color:'cyan', weight:5}] },
      router: L.Routing.osrmv1({ serviceUrl:'https://router.project-osrm.org/route/v1' })
    }).addTo(map);
  } else {
    map.panTo(currentDest.coords);
  }
}

/* ================== GEO & ARRIVAL ========== */
function bearingBetween(a,b){
  const toRad = Math.PI/180, toDeg = 180/Math.PI;
  const lat1 = a[0]*toRad, lat2 = b[0]*toRad;
  const dLon = (b[1]-a[1])*toRad;
  const y = Math.sin(dLon)*Math.cos(lat2);
  const x = Math.cos(lat1)*Math.sin(lat2) - Math.sin(lat1)*Math.cos(lat2)*Math.cos(dLon);
  let brng = Math.atan2(y,x)*toDeg;
  brng = (brng + 360) % 360;
  return brng;
}

function checkArrival(lat,lng){
  if(!currentDest) return;
  const dist = map.distance([lat,lng], currentDest.coords);
  if(dist <= 30){
    statusBubble.textContent = `Chegou em ${currentDest.nome}`;
    confirmBtn.style.display = 'block';
    confirmBtn.onclick = ()=>{
      const row = filteredData.find(r=> (r[2]||'').trim().toLowerCase() === (currentDest.nome||'').trim().toLowerCase());
      if(row){
        const key = bookingKey(row);
        if(!embarcados.includes(key)) embarcados.push(key);
        localStorage.setItem(EMBARCADOS_KEY, JSON.stringify(embarcados));
      }
      if(routeControl){ try{ routeControl.remove(); }catch(e){} routeControl=null; }
      if(destMarker){ try{ map.removeLayer(destMarker); }catch(e){} destMarker=null; }
      currentDest = null;
      confirmBtn.style.display='none';
      loadBookings(true);
      clearNewAlerts();
      statusBubble.textContent='Aguardando';
    };
  } else {
    confirmBtn.style.display='none';
  }
}

function onGeoSuccess(pos){
  const lat = pos.coords.latitude, lng = pos.coords.longitude;
  if(!driverMarker){
    driverMarker = L.marker([lat,lng], {icon: carIcon}).addTo(map);
    map.setView([lat,lng], 16);
  } else {
    driverMarker.setLatLng([lat,lng]);
  }
  if(currentDest){
    const brng = bearingBetween([lat,lng], currentDest.coords);
    rotateMarkerIcon(driverMarker, brng);
    arrowEl.style.transform = `rotate(${brng}deg)`;
    // update route first waypoint to current location
    try{
      if(routeControl && typeof routeControl.spliceWaypoints === 'function'){
        routeControl.spliceWaypoints(0,1,L.latLng(lat,lng));
      } else if(routeControl && typeof routeControl.setWaypoints === 'function'){
        const wps = routeControl.getWaypoints ? routeControl.getWaypoints() : null;
        if(wps && wps.length >= 2){
          routeControl.setWaypoints([ L.latLng(lat,lng), wps[wps.length-1].latLng || L.latLng(currentDest.coords[0], currentDest.coords[1]) ]);
        }
      }
    }catch(e){}
    const dist = map.distance([lat,lng], currentDest.coords);
    statusBubble.textContent = `Distância: ${Math.round(dist)} m`;
    checkArrival(lat,lng);
  }
}

function onGeoError(err){ console.warn('Geolocation error', err); statusBubble.textContent='GPS indisponível'; }

function startGeoWatch(){
  if('geolocation' in navigator && !watchId){
    watchId = navigator.geolocation.watchPosition(onGeoSuccess, onGeoError, { enableHighAccuracy:true, maximumAge:0, timeout:10000 });
  }
}

/* ================== PERMISSIONS FLOW (mobile friendly) ========== */
async function startPermissionsFlow(){
  try{ await audioCtx.resume(); }catch(e){}
  if(Notification.permission === 'default' && !localStorage.getItem(SKIPPED_PERMS_KEY)){
    try{ await Notification.requestPermission(); }catch(e){}
  }
  if('geolocation' in navigator){
    navigator.geolocation.getCurrentPosition((p)=>{ startGeoWatch(); }, (err)=>{ startGeoWatch(); }, { enableHighAccuracy:true, timeout:10000 });
  } else startGeoWatch();
  desktopOverlay.style.display='none';
}
function skipPermissionsAndStart(){ localStorage.setItem(SKIPPED_PERMS_KEY,'1'); startGeoWatch(); desktopOverlay.style.display='none'; }

menuToggle.addEventListener('click', ()=>{ menu.classList.toggle('open'); if('Notification' in window && Notification.permission==='default'){ Notification.requestPermission().catch(()=>{}); } });
grantPermissionsBtn.addEventListener('click', ()=> startPermissionsFlow());
skipPermissionsBtn.addEventListener('click', ()=> skipPermissionsAndStart());

/* ================== INIT ================== */
if(localStorage.getItem(SKIPPED_PERMS_KEY) || Notification.permission === 'granted' || Notification.permission === 'denied'){
  desktopOverlay.style.display='none';
  startGeoWatch();
} else {
  desktopOverlay.style.display='flex';
}

loadBookings(true);
setInterval(()=> loadBookings(false), POLL_INTERVAL_MS);

/* expose debug helpers */
window.__driverApp = { loadBookings, startGeoWatch, seenRequests, embarcados, clearNewAlerts };

</script>
</body>
</html>
