<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Coleta Transfer Inauguração - Driver</title>

<!-- estilos mobile-first -->
<style>
  :root{
    --bg1:#05060a; --bg2:#0f1224; --accent:#00ffd5; --muted:rgba(255,255,255,0.08);
  }
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,var(--bg1),var(--bg2)); color:#eafffb;}
  header{height:56px; position:fixed; left:0; right:0; top:0; z-index:9999; display:flex; align-items:center; gap:12px; padding:8px 12px; background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-bottom:1px solid rgba(255,255,255,0.02);}
  .logo{width:36px;height:36px;border-radius:8px;background:#fff;}
  .title{color:var(--accent); font-weight:700; font-size:17px;}
  #app{padding-top:56px; height:100vh; display:flex; overflow:hidden;}
  #map{flex:1; border-radius:0; height:100%;}
  #menu{position:fixed; left:-300px; top:56px; width:280px; height:calc(100%-56px); background:rgba(0,0,0,0.9); overflow:auto; transition:0.3s; z-index:9999; padding:8px;}
  #menu.open{left:0;}
  .item{display:flex; justify-content:space-between; align-items:center; gap:8px; padding:10px; border-radius:10px; margin-bottom:8px; background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));}
  .meta{display:flex;flex-direction:column;}
  .hour{color:var(--accent); font-weight:900;}
  .point{color:#dff; font-size:13px;}
  .name{color:#cfe; font-size:12px;}
  .btn{background:var(--accent); color:#000; border:none; padding:6px 10px; border-radius:10px; font-weight:800; cursor:pointer;}
  .btn-go{background:#00bfff;color:#000;}
  .btn-confirm{background:#ff3b30;color:#fff;}
  #menuToggle{position:fixed;top:8px;left:8px;z-index:10000;background:var(--accent);color:#000;padding:6px 12px;border:none;border-radius:8px;cursor:pointer;}
  #desktopOverlay{display:none; position:fixed;inset:0; background:rgba(0,0,0,0.8); z-index:999999; align-items:center; justify-content:center;}
  #desktopOverlay .card{background:rgba(255,255,255,0.02); padding:18px;border-radius:12px; color:#fff; max-width:420px; text-align:center;}
  @media(min-width:900px){ #desktopOverlay{display:flex;} #map{filter:blur(3px);} }
</style>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
</head>
<body>

<header>
  <div class="logo" aria-hidden="true"></div>
  <div class="title">Coleta Transfer Inauguração</div>
</header>

<button id="menuToggle">☰ Pontos</button>
<div id="menu"></div>

<div id="app">
  <div id="map"></div>
</div>

<div id="desktopOverlay" aria-hidden="true">
  <div class="card">
    <h2 style="color:#00ffd5;margin:0 0 8px">Abra no celular</h2>
    <p style="color:#ddd;margin:0">Este painel foi otimizado como webapp de navegação para celular. Abra no navegador do seu celular para usar GPS.</p>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
/* ================== CONFIG ================== */
const SHEET_ID = "132fh2lxEE2vzpfBmAbYCsk4UtRJAZ6fjdLEplUqbwFc";
const SHEETS_API_KEY = "AIzaSyCkkBqKGxqPsBHK4-tQN_8DhdNMmX4gaqU";
const RANGE = "A:E";
const SHEETS_URL = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${SHEETS_API_KEY}`;

let allData=[], filteredData=[], embarcados=JSON.parse(localStorage.getItem('embarcados_v3')||'[]');
let map, driverMarker, routeLayer, currentDest;
const menu=document.getElementById('menu');
const menuToggle=document.getElementById('menuToggle');
const pontos = [
  {nome:"PORTARIA", coords:[-19.9978072,-43.9266727]},
  {nome:"Ponto 30", coords:[-19.9977078,-43.9289372]},
  {nome:"Ponto 28", coords:[-19.9986592,-43.9306448]},
  {nome:"Ponto 29", coords:[-19.999421,-43.9326796]},
  {nome:"Ponto 27", coords:[-20.0002531,-43.9314901]},
  {nome:"Ponto 26", coords:[-20.0015469,-43.9333477]},
  {nome:"Ponto 24", coords:[-20.003258,-43.9296246]},
  {nome:"Ponto 25", coords:[-20.0050238,-43.9308419]},
  {nome:"Ponto 21", coords:[-20.0027213,-43.9338594]},
  {nome:"Ponto 22", coords:[-20.001474,-43.9355339]},
  {nome:"Ponto 23", coords:[-20.0031588,-43.9364208]},
  {nome:"Ponto 20", coords:[-20.0063663,-43.934352]},
  {nome:"Ponto 19", coords:[-20.0085746,-43.9318072]},
  {nome:"Ponto 17", coords:[-20.0104645,-43.9320381]},
  {nome:"Ponto 18", coords:[-20.0088433,-43.9343321]},
  {nome:"Ponto 12", coords:[-20.0088434,-43.9288248]},
  {nome:"Ponto 13", coords:[-20.0094456,-43.9269802]},
  {nome:"Ponto 14", coords:[-20.0075172,-43.9277972]},
  {nome:"Ponto 16", coords:[-20.0068404,-43.9290337]},
  {nome:"Ponto 15", coords:[-20.0079616,-43.9293497]},
  {nome:"Ponto 09", coords:[-20.0110997,-43.9309597]},
  {nome:"Ponto 10", coords:[-20.0120307,-43.9334509]},
  {nome:"Ponto 11", coords:[-20.0098192,-43.9337648]},
  {nome:"Ponto 08", coords:[-20.0102615,-43.9273848]},
  {nome:"Ponto 05", coords:[-20.0114455,-43.9257426]},
  {nome:"Ponto 06", coords:[-20.0112228,-43.9276231]},
  {nome:"Ponto 07", coords:[-20.0108785,-43.9296971]},
  {nome:"Ponto 04", coords:[-20.0068997,-43.9238609]},
  {nome:"Ponto 03", coords:[-20.0047577,-43.9260624]},
  {nome:"Ponto 02", coords:[-20.001753,-43.9270223]}
];

/* ================== UTIL ================== */
function todayYMD(){
  const n=new Date();
  return `${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}-${String(n.getDate()).padStart(2,'0')}`;
}
function parseSheetDateTime(val){
  if(!val) return null;
  if(val.includes('/')){
    const [dpart,tpart='00:00']=val.split(' ');
    const [d,m,y]=dpart.split('/');
    const [hh,mm]=tpart.split(':');
    const dt=new Date(Number(y),Number(m)-1,Number(d),Number(hh||0),Number(mm||0));
    return isNaN(dt)?null:dt;
  }
  const dt=new Date(val);
  return isNaN(dt)?null:dt;
}
function bookingKey(row){return `${(row[1]||'').trim()}___${(row[2]||'').trim()}___${(row[0]||'').trim()}`;}
function speak(text){console.log('NAV:',text);}

/* ================== UI ================== */
function renderMenu(rows){
  menu.innerHTML='';
  if(!rows.length){
    menu.innerHTML='<div style="padding:12px;color:#cfe">Nenhum agendamento disponível.</div>';
    return;
  }
  rows.forEach(r=>{
    const dt=parseSheetDateTime(r[0]);
    const hh=dt?`${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}`:'';
    const div=document.createElement('div'); div.className='item';
    div.innerHTML=`<div class="meta"><div class="hour">${hh}</div><div class="point">${r[2]||''}</div><div class="name">${r[1]||''}</div></div>
      <div><button class="btn btn-go" data-key="${encodeURIComponent(bookingKey(r))}">Ir</button></div>`;
    menu.appendChild(div);
    div.querySelector('.btn-go').addEventListener('click', ()=>startNavigationTo(r));
  });
}

menuToggle.addEventListener('click', ()=>menu.classList.toggle('open'));

/* ================== MAP ================== */
map=L.map('map',{zoomControl:true}).setView([-19.9978072,-43.9266727],15);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap'}).addTo(map);
routeLayer=L.layerGroup().addTo(map);

const carIcon=L.icon({
  iconUrl:'https://cdn-icons-png.flaticon.com/512/61/61168.png',
  iconSize:[40,40],
  iconAnchor:[20,20]
});

/* ================== LOAD BOOKINGS ================== */
async function loadBookings(){
  try{
    const res=await fetch(SHEETS_URL);
    const json=await res.json();
    if(!json || !json.values || json.values.length<=1){ allData=[]; filteredData=[]; renderMenu([]); return; }
    const rows=json.values.slice(1);
    const today=todayYMD();
    const kept=rows.filter(r=>{
      const dt=parseSheetDateTime(r[0]);
      if(!dt) return false;
      const yyyy=dt.getFullYear(), mm=String(dt.getMonth()+1).padStart(2,'0'), dd=String(dt.getDate()).padStart(2,'0');
      const rowYMD=`${yyyy}-${mm}-${dd}`;
      if(rowYMD!==today) return false;
      if(dt.getHours()<19) return false;
      const key=bookingKey(r);
      if(embarcados.includes(key)) return false;
      return true;
    });
    allData=kept; filteredData=allData.slice();
    renderMenu(filteredData);
  }catch(e){ console.error(e); alert('Erro ao buscar dados da planilha'); }
}
loadBookings();

/* ================== NAVIGATION VIA OSRM ================== */
async function getRouteOSRM(start, end){
  try{
    const res=await fetch(`https://router.project-osrm.org/route/v1/driving/${start[1]},${start[0]};${end[1]},${end[0]}?geometries=geojson`);
    const data=await res.json();
    if(data && data.routes && data.routes[0]){
      return data.routes[0].geometry.coordinates.map(c=>[c[1],c[0]]);
    }
    return null;
  }catch(e){ console.error(e); return null; }
}

let watchId;

function startNavigationTo(row){
  currentDest=pontos.find(p=>p.nome===row[2]);
  if(!currentDest){ alert('Destino inválido'); return; }

  if(watchId) navigator.geolocation.clearWatch(watchId);

  watchId=navigator.geolocation.watchPosition(async pos=>{
    const latlng=[pos.coords.latitude,pos.coords.longitude];
    if(driverMarker){ driverMarker.setLatLng(latlng); }
    else{ driverMarker=L.marker(latlng,{icon:carIcon}).addTo(map); }
    map.setView(latlng,17);

    if(currentDest){
      const routeCoords=await getRouteOSRM(latlng,currentDest.coords);
      if(routeCoords){
        routeLayer.clearLayers();
        L.polyline(routeCoords,{color:'#00ffd5',weight:5}).addTo(routeLayer);
      }

      // proximidade
      const dx=latlng[0]-currentDest.coords[0];
      const dy=latlng[1]-currentDest.coords[1];
      const dist=Math.sqrt(dx*dx+dy*dy)*111000;
      if(dist<50){
        const btn=document.querySelector(`button[data-key="${encodeURIComponent(bookingKey(row))}"]`);
        if(btn){ btn.textContent='Confirmar Embarque'; btn.className='btn btn-confirm'; btn.onclick=()=>confirmEmbarque(row); }
      }
    }
  }, e=>{ console.warn(e); alert('Erro ao obter localização'); }, {enableHighAccuracy:true, maximumAge:1000, timeout:5000});
}

/* ================== CONFIRMAR EMBARQUE ================== */
function confirmEmbarque(row){
  const key=bookingKey(row);
  if(!embarcados.includes(key)) embarcados.push(key);
  localStorage.setItem('embarcados_v3',JSON.stringify(embarcados));
  filteredData=filteredData.filter(r=>bookingKey(r)!==key);
  allData=allData.filter(r=>bookingKey(r)!==key);
  renderMenu(filteredData);
  routeLayer.clearLayers();
  currentDest=null;
  speak('Embarque confirmado');
}
</script>
</body>
</html>
