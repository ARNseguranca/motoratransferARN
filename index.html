<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Coleta Transfer Inaugura√ß√£o - Driver</title>

<style>
  :root{
    --bg1:#05060a; --bg2:#0f1224; --accent:#00ffd5; --muted:rgba(255,255,255,0.06);
  }
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,var(--bg1),var(--bg2)); color:#eafffb; -webkit-font-smoothing:antialiased;}
  header{height:56px; position:fixed; left:0; right:0; top:0; z-index:9999; display:flex; align-items:center; gap:12px; padding:8px 12px; background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-bottom:1px solid rgba(255,255,255,0.02);}
  .logo{width:36px;height:36px;border-radius:8px;background:#fff;}
  .title{color:var(--accent); font-weight:700; font-size:17px;}
  #app{padding-top:56px; height:100vh; display:flex; overflow:hidden;}
  #map{flex:1; height:100%; min-height:200px;}
  #menu{position:fixed; left:-320px; top:56px; width:320px; height:calc(100% - 56px); background:rgba(0,0,0,0.92); overflow:auto; transition:0.28s; z-index:9999; padding:12px; box-sizing:border-box;}
  #menu.open{left:0;}
  .item{display:flex; justify-content:space-between; align-items:center; gap:8px; padding:10px; border-radius:10px; margin-bottom:8px; background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));}
  .meta{display:flex;flex-direction:column;}
  .hour{color:var(--accent); font-weight:900; font-size:14px;}
  .point{color:#dff; font-size:14px; margin-top:4px;}
  .name{color:#cfe; font-size:12px;}
  .btn{background:var(--accent); color:#000; border:none; padding:8px 12px; border-radius:10px; font-weight:800; cursor:pointer;}
  .btn-go{background:#00bfff;color:#000;}
  .btn-confirm{background:#ff3b30;color:#fff;}
  #menuToggle{position:fixed;top:8px;left:8px;z-index:10000;background:var(--accent);color:#000;padding:8px 12px;border:none;border-radius:8px;cursor:pointer;box-shadow:0 8px 20px rgba(0,0,0,0.4);}
  #desktopOverlay{display:none; position:fixed;inset:0; background:rgba(0,0,0,0.8); z-index:999998; align-items:center; justify-content:center;}
  #desktopOverlay .card{background:rgba(255,255,255,0.02); padding:18px;border-radius:12px; color:#fff; max-width:420px; text-align:center;}
  @media(min-width:900px){ #desktopOverlay{display:flex;} #map{filter:blur(3px);} }
  #arrow{position:fixed; right:12px; bottom:110px; z-index:100000; width:72px; height:72px; background:rgba(0,0,0,0.55); border-radius:12px; display:flex; align-items:center; justify-content:center; box-shadow:0 8px 30px rgba(0,0,0,0.6); transform-origin:center center; transition:transform 0.25s linear;}
  #arrow svg{width:42px;height:42px; fill:var(--accent);}
  #statusBubble{position:fixed;right:12px;bottom:24px;z-index:100000;background:rgba(0,0,0,0.6);padding:8px 12px;border-radius:10px;color:#cfe;font-weight:700;font-size:13px;}
  .hint{font-size:12px;color:#9df;margin-top:6px;}

  /* ALERTA VISUAL */
  #alerta {
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background: red;
    color: white;
    padding: 20px 28px;
    border-radius: 12px;
    font-size: 20px;
    font-weight: bold;
    display: none;
    z-index: 200000;
    box-shadow: 0 0 25px rgba(0,0,0,0.7);
    text-align: center;
    animation: pulse 1s infinite;
  }
  #alerta button {
    margin-top: 12px;
    background: #fff;
    color: red;
    font-weight: bold;
    border: none;
    padding: 8px 14px;
    border-radius: 8px;
    cursor: pointer;
  }
  @keyframes pulse {
    0% { transform: translate(-50%, -50%) scale(1); }
    50% { transform: translate(-50%, -50%) scale(1.1); }
    100% { transform: translate(-50%, -50%) scale(1); }
  }
</style>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
</head>
<body>

<header>
  <div class="logo" aria-hidden="true"></div>
  <div class="title">Coleta Transfer Inaugura√ß√£o</div>
</header>

<button id="menuToggle" aria-label="Abrir menu">‚ò∞ Pontos</button>
<div id="menu" aria-hidden="true"></div>

<div id="app">
  <div id="map" role="application" aria-label="Mapa"></div>
</div>

<div id="arrow" title="Dire√ß√£o" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M12 2 L3 21 L12 17 L21 21 Z"></path></svg></div>
<div id="statusBubble">Aguardando</div>

<div id="desktopOverlay" aria-hidden="true">
  <div class="card">
    <h2 style="color:#00ffd5;margin:0 0 8px">Abra no celular</h2>
    <p style="color:#ddd;margin:0">Este painel foi otimizado como webapp de navega√ß√£o para celular. Abra no navegador do seu celular para usar GPS e notifica√ß√µes.</p>
  </div>
</div>

<!-- ALERTA VISUAL -->
<div id="alerta">
  üö® NOVA SOLICITA√á√ÉO!
  <br>
  <button onclick="fecharAlerta()">Fechar</button>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* ============== CONFIG E VARI√ÅVEIS PRINCIPAIS ============== */
const SHEET_ID = "132fh2lxEE2vzpfBmAbYCsk4UtRJAZ6fjdLEplUqbwFc";
const SHEETS_API_KEY = "AIzaSyCkkBqKGxqPsBHK4-tQN_8DhdNMmX4gaqU";
const RANGE = "A:E";
const SHEETS_URL = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${SHEETS_API_KEY}`;
let ultimaAtualizacao = 0;
let loopOsc = null; // armazenar som cont√≠nuo

/* ============== SOM ============== */
function startBeepLoop(){
  if(loopOsc) return; // j√° tocando
  const ctx = new (window.AudioContext||window.webkitAudioContext)();
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  osc.type = "sine";
  osc.frequency.value = 880;
  osc.connect(gain);
  gain.connect(ctx.destination);
  osc.start();
  loopOsc = {ctx,osc};
}
function stopBeepLoop(){
  if(loopOsc){
    loopOsc.osc.stop();
    loopOsc.ctx.close();
    loopOsc = null;
  }
}

/* ============== ALERTA VISUAL ============== */
function showVisualAlert(msg){
  const alerta = document.getElementById('alerta');
  alerta.style.display = "block";
  alerta.firstChild.textContent = "üö® " + msg + "!";
  startBeepLoop();
}
function fecharAlerta(){
  document.getElementById('alerta').style.display = "none";
  stopBeepLoop();
}

/* ============== NOTIFICAR NOVAS MARCA√á√ïES ============== */
async function notifyNewBooking(message){
  showVisualAlert(message); // mostra alerta vermelho + inicia som

  if(driverMarker){
    driverMarker.bindPopup(`<b>${message}</b>`).openPopup();
  }
  if('Notification' in window && Notification.permission === 'granted'){
    try {
      const n = new Notification('Nova marca√ß√£o', { body: message, icon: 'https://cdn-icons-png.flaticon.com/512/60/60577.png' });
      n.onclick = ()=>{ window.focus(); menu.classList.add('open'); };
    } catch(e){ console.warn('notify err', e); }
  } else {
    statusBubble.textContent = message;
    setTimeout(()=>{ statusBubble.textContent='Aguardando'; }, 5000);
  }
}

/* ============== (restante do seu c√≥digo segue igual ‚Äî loadBookings, mapa, etc.) ============== */
// Aqui voc√™ mant√©m todo o restante j√° pronto (geolocaliza√ß√£o, menu, rota, etc.)
// Apenas troquei a fun√ß√£o notifyNewBooking acima.

</script>
</body>
</html>
